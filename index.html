<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Nutrient Finder</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçé</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.3.0/math.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        [x-cloak] { display: none !important; }
        .sort-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-left: 0.5rem;
            color: #9ca3af;
            transition: color 0.2s;
        }
        th:hover .sort-icon {
            color: #374151;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #1e40af; /* blue-800 */
            font-weight: 600;
        }
        .remove-icon {
            cursor: pointer;
            color: #ef4444; /* red-500 */
            font-weight: bold;
            padding-right: 0.25rem; /* Task 1: Smaller blank space */
            font-size: 1.25rem; /* Larger remove icon */
        }
        .remove-icon:hover {
            color: #b91c1c; /* red-700 */
        }
        #search-results, .modal {
            z-index: 20;
        }
        #table-container {
            overflow-x: auto;
        }
        .sticky-col {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            left: 0;
            z-index: 10;
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #nutrient-table thead .sticky-col {
            background-color: #f3f4f6; /* gray-100, same as thead */
        }
        #nutrient-table tbody tr .sticky-col {
            background-color: #ffffff; /* white, same as row */
        }
        .text-zero {
            color: #d1d5db; /* gray-300 */
        }
        .back-arrow {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }
        .nutrient-table th, .nutrient-table td {
            padding: 3px 8px; /* Reduced padding */
            text-align: right;
            min-width: 90px; /* Added min-width */
        }
        .nutrient-table th:first-child, .nutrient-table td:first-child {
            text-align: left;
        }
        .nutrient-table th {
            font-weight: 600;
            background-color: #f9fafb;
        }
        .percent-cell {
            color: #4b5563;
            font-size: 0.875rem;
        }
        .blue-btn {
            background-color: #3b82f6;
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .blue-btn:hover {
            background-color: #2563eb;
        }
        .blue-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
        .optimize-btn {
            background-color: #8b5cf6;
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .optimize-btn:hover {
            background-color: #7c3aed;
        }
        .optimize-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px #ddd6fe;
        }
        .lock-icon {
            cursor: pointer;
            margin-left: 0.5rem;
            color: #6b7280;
            transition: color 0.2s;
        }
        .lock-icon:hover {
            color: #3b82f6;
        }
        .lock-icon.locked {
            color: #3b82f6;
        }
        .quantity-input:disabled {
            background-color: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }
        .create-food-btn {
            background-color: #f3f4f6;
            border-radius: 0.25rem;
            padding: 0.5rem;
            text-align: left;
            width: 100%;
            margin-bottom: 0.5rem;
            color: #3b82f6;
            font-weight: 500;
        }
        .create-food-btn:hover {
            background-color: #e5e7eb;
        }
        .modal-food-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            justify-content: flex-start; /* Left justify */
        }
        .modal-label {
            text-align: left;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
        }
        .nutrient-clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .nutrient-clickable:hover {
            color: #3b82f6;
            text-decoration: underline;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 text-base" x-data="foodApp()" x-init="init()" x-cloak>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Food Nutrient Finder <sup class="text-lg font-medium text-gray-400">v2.2</sup></h1>
            <p class="text-base sm:text-lg text-gray-600 mt-2">Search, track, and manage your nutritional intake.</p>
        </header>

        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-4 sm:space-x-8 overflow-x-auto" aria-label="Tabs">
                <button @click="activeTab = 'foods'" :class="{'active': activeTab === 'foods'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Foods</button>
                <button @click="activeTab = 'targets'" :class="{'active': activeTab === 'targets'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Nutrient Targets</button>
                <button @click="activeTab = 'diets'; selectedDiet = null" :class="{'active': activeTab === 'diets'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Diets</button>
                <button @click="activeTab = 'tracker';" :class="{'active': activeTab === 'tracker'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Tracker</button>
            </nav>
        </div>

        <div id="content-foods" class="tab-content" x-show="activeTab === 'foods'">
            <div class="mt-4 mb-12">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                     <h2 class="text-2xl font-semibold text-gray-800">My Foods</h2>
                     <div class="flex gap-2">
                        <button @click="openAddFoodModal()" class="blue-btn">Add Food</button>
                        <button @click="openAddNutrientModal()" class="blue-btn">Add Nutrient</button>
                     </div>
                </div>
                <div id="table-container" class="bg-white rounded-lg shadow" x-show="storedFoods.length > 0 || isCreatingFood">
                    <table id="nutrient-table" class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <template x-for="header in displayHeaders" :key="header">
                                    <th scope="col" class="px-6 py-2 cursor-pointer text-xs" :class="{'sticky-col': header === 'name'}" @click="changeSort(header)">
                                        <span x-text="header"></span>
                                        <span class="sort-icon" x-html="sortColumn === header ? (sortDirection === 'asc' ? '&#9650;' : '&#9660;') : ''"></span>
                                    </th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="isCreatingFood">
                                <tr id="new-food-row" class="bg-gray-50">
                                    <template x-for="header in displayHeaders" :key="header">
                                        <td class="p-1">
                                            <input :type="header === 'name' ? 'text' : 'number'" :placeholder="header" x-model="newFood[header]" class="w-full p-2 border rounded-md text-sm">
                                        </td>
                                    </template>
                                    <td class="p-1 whitespace-nowrap">
                                        <button @click="saveNewFood()" class="blue-btn text-xs px-3 py-1">Save</button>
                                        <button @click="cancelNewFood()" class="ml-2 px-3 py-1 bg-gray-500 text-white text-xs rounded-md hover:bg-gray-600">Cancel</button>
                                    </td>
                                </tr>
                            </template>
                            <template x-for="(food, index) in sortedStoredFoods" :key="food.name">
                                <tr class="bg-white border-b">
                                    <template x-for="header in displayHeaders" :key="header">
                                        <td :class="{
                                            'px-2 py-3 font-medium text-gray-900 sticky-col text-sm': header === 'name',
                                            'px-2 py-3 min-w-sm text-sm': header !== 'name',
                                            'text-zero': typeof food[header] === 'number' && food[header] === 0
                                        }" :title="food[header]">
                                            <template x-if="header === 'name'">
                                                <div class="flex items-center">
                                                    <span @click="removeFood(food.name)" class="remove-icon">&times;</span>
                                                    <input type="text" x-model="food.name" @change="saveStoredFoods()" class="w-full p-1 border-b focus:outline-none focus:border-blue-500 bg-transparent">
                                                </div>
                                            </template>
                                            <template x-if="header !== 'name'">
                                                <input type="number" x-model.number="food[header]" @change="saveStoredFoods()" class="w-full p-1 border-b focus:outline-none focus:border-blue-500 bg-transparent text-right">
                                            </template>
                                        </td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div id="table-placeholder" class="text-center p-8 text-gray-500" x-show="storedFoods.length === 0 && !isCreatingFood">
                    <p>Your added foods will appear here.</p>
                </div>
                <button @click="clearAll()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" :disabled="storedFoods.length === 0">Clear All Foods</button>
            </div>
        </div>

        <div id="content-targets" class="tab-content p-6 bg-white rounded-lg shadow" x-show="activeTab === 'targets'">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Nutrient Targets</h2>
            <div id="targets-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4">
                <template x-for="nutrient in displayHeaders.filter(h => h !== 'name')" :key="nutrient">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span @click="removeNutrientColumn(nutrient)" class="remove-icon">&times;</span>
                            <label :for="`target-${nutrient}`" x-text="nutrient" class="text-sm font-medium text-gray-700"></label>
                        </div>
                        <input 
                            type="number" 
                            :id="`target-${nutrient}`" 
                            x-model.number="nutrientTargets[nutrient]" 
                            @change="saveTargets()"
                            class="w-32 p-2 border rounded-md text-sm" 
                            placeholder="0.00"
                        >
                    </div>
                </template>
            </div>
            <div class="mt-8 flex justify-end items-center gap-4">
                <button @click="openAddNutrientModal()" class="blue-btn">Add Nutrient</button>
            </div>
        </div>

        <div id="content-diets" class="tab-content p-6 bg-white rounded-lg shadow" x-show="activeTab === 'diets'">
            <!-- Diet list view -->
            <div x-show="!selectedDiet">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <button @click="createDiet()" class="blue-btn">Create New Diet</button>
                </div>
                
                <div class="border rounded-lg overflow-hidden">
                    <template x-if="diets.length === 0">
                        <p class="p-4 text-gray-500">No diets created yet. Create your first diet!</p>
                    </template>
                    <template x-for="diet in diets" :key="diet.id">
                        <div class="flex justify-between items-center p-4 border-b hover:bg-gray-50 cursor-pointer" @click="selectDiet(diet)">
                            <div class="flex items-center">
                                <span @click.stop="deleteDiet(diet.id)" class="remove-icon">&times;</span>
                                <span x-text="diet.name" class="font-medium"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Diet edit view -->
            <div x-show="selectedDiet">
                <div class="flex items-center mb-6">
                    <span @click="selectedDiet = null" class="back-arrow">‚Üê</span>
                    <input type="text" x-model="selectedDiet.name" class="text-xl font-medium border-b border-gray-300 focus:border-blue-500 focus:outline-none" placeholder="Diet name">
                </div>
                
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-4">Diet Foods</h4>
                    <div id="diet-foods-list" class="grid grid-cols-1 gap-y-4 mb-8">
                        <template x-if="selectedDiet.foods.length === 0">
                            <p class="text-gray-500">No foods added to this diet yet.</p>
                        </template>
                        <template x-for="(foodItem, index) in selectedDiet.foods" :key="index">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span @click="removeFoodFromDiet(foodItem.foodName)" class="remove-icon">&times;</span>
                                    <span x-text="foodItem.foodName" class="text-sm font-medium"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" 
                                           x-model.number="foodItem.quantity" 
                                           min="0" 
                                           step="1" 
                                           :disabled="foodItem.locked"
                                           class="w-24 p-2 border rounded-md text-sm quantity-input" 
                                           placeholder="Quantity">
                                    <span>grams</span>
                                    <i 
                                        :class="{
                                            'fa-solid': true,
                                            'fa-lock': foodItem.locked,
                                            'fa-lock-open': !foodItem.locked,
                                            'lock-icon': true,
                                            'locked': foodItem.locked
                                        }" 
                                        @click="foodItem.locked = !foodItem.locked; saveDiets()"
                                        title="Lock quantity for optimization"
                                    ></i>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div class="mt-4 flex justify-end gap-2">
                        <button @click="isAddingFood = true; addFoodContext = 'diet'; resetFoodModal()" class="blue-btn">Add Food</button>
                        <button @click="suggestFood()" class="blue-btn">Suggest Food</button>
                        <button @click="optimizeDiet()" class="optimize-btn">Optimize</button>
                    </div>
                </div>
                
                <!-- Nutrient Summary Section -->
                <div x-show="selectedDiet.foods.length > 0">
                    <h4 class="text-lg font-medium mb-4">Nutrient Summary</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full nutrient-table">
                            <thead>
                                <tr>
                                    <th class="text-left">Nutrient</th>
                                    <th>Total Amount</th>
                                    <th>% of Target</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="nutrient in displayHeaders.filter(h => h !== 'name')" :key="nutrient">
                                    <tr>
                                        <td class="text-left nutrient-clickable" @click="showNutrientContribution(nutrient)" x-text="nutrient"></td>
                                        <td x-text="calculateNutrientTotal(nutrient).toFixed(2)"></td>
                                        <td>
                                            <span x-text="calculateNutrientPercentage(nutrient).toFixed(0) + '%'"></span>
                                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1" x-show="nutrientTargets[nutrient] > 0">
                                                <div class="bg-blue-600 h-2.5 rounded-full" 
                                                    :style="'width: ' + Math.min(100, calculateNutrientPercentage(nutrient)) + '%'"
                                                    :class="{
                                                        'bg-green-600': calculateNutrientPercentage(nutrient) >= 100,
                                                        'bg-yellow-400': calculateNutrientPercentage(nutrient) >= 75 && calculateNutrientPercentage(nutrient) < 100,
                                                        'bg-orange-500': calculateNutrientPercentage(nutrient) >= 50 && calculateNutrientPercentage(nutrient) < 75,
                                                        'bg-red-500': calculateNutrientPercentage(nutrient) < 50
                                                    }">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tracker Tab -->
        <div id="content-tracker" class="tab-content p-6 bg-white rounded-lg shadow" x-show="activeTab === 'tracker'">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Daily Nutrient Tracker</h2>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Date</label>
                <input type="date" x-model="trackerDate" class="p-2 border rounded-md w-full max-w-xs">
            </div>
            
            <div class="mb-8">
                <h4 class="text-lg font-medium mb-4">Tracked Foods</h4>
                <div class="border rounded-lg overflow-hidden mb-4">
                    <template x-if="trackedFoods.length === 0">
                        <p class="p-4 text-gray-500">No foods tracked for today. Add some foods to track your nutrients.</p>
                    </template>
                    <template x-for="(foodItem, index) in trackedFoods" :key="index">
                        <div class="flex items-center justify-between p-4 border-b hover:bg-gray-50">
                            <div class="flex items-center">
                                <span @click="removeTrackedFood(foodItem.foodName)" class="remove-icon">&times;</span>
                                <span x-text="foodItem.foodName" class="text-sm font-medium"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" 
                                       x-model.number="foodItem.quantity" 
                                       min="0" 
                                       step="1"
                                       class="w-24 p-2 border rounded-md text-sm" 
                                       placeholder="Quantity">
                                <span>grams</span>
                            </div>
                        </div>
                    </template>
                </div>
                <button @click="isAddingFood = true; addFoodContext = 'tracker'; resetFoodModal()" class="blue-btn">Add Food</button>
            </div>
            
            <div x-show="trackedFoods.length > 0">
                <h4 class="text-lg font-medium mb-4">Daily Nutrient Summary</h4>
                <div class="overflow-x-auto">
                    <table class="w-full nutrient-table">
                        <thead>
                            <tr>
                                <th class="text-left">Nutrient</th>
                                <th>Target</th>
                                <th>Consumed</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="nutrient in displayHeaders.filter(h => h !== 'name')" :key="nutrient">
                                <tr>
                                    <td class="text-left" x-text="nutrient"></td>
                                    <td x-text="nutrientTargets[nutrient] || 0"></td>
                                    <td x-text="calculateDailyIntake(nutrient).toFixed(2)"></td>
                                    <td>
                                        <div class="progress-bar">
                                            <div class="progress-fill" 
                                                 :style="'width: ' + Math.min(100, (calculateDailyIntake(nutrient) / (nutrientTargets[nutrient] || 1) * 100) + '%'"
                                                 :class="{
                                                     'bg-green-600': (calculateDailyIntake(nutrient) >= (nutrientTargets[nutrient] || 0),
                                                     'bg-blue-500': (calculateDailyIntake(nutrient) < (nutrientTargets[nutrient] || 0)
                                                 }">
                                            </div>
                                        </div>
                                        <span class="percent-cell" 
                                              x-text="nutrientTargets[nutrient] ? Math.min(100, (calculateDailyIntake(nutrient) / nutrientTargets[nutrient] * 100).toFixed(0) + '%' : 'N/A'">
                                        </span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Food Modal -->
    <div x-show="isAddingFood" @keydown.escape.window="isAddingFood = false" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="isAddingFood = false" class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add Food</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" x-model.debounce.300ms="searchQuery" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Search for a food...">
                </div>
                <div class="max-h-60 overflow-y-auto border rounded-md">
                    <!-- Create new food button -->
                    <button 
                        x-show="searchQuery" 
                        @click="createNewFoodFromSearch()" 
                        class="create-food-btn"
                    >
                        <i class="fas fa-plus-circle mr-2"></i> Create new food: <span x-text="searchQuery"></span>
                    </button>
                    
                    <ul class="divide-y divide-gray-200">
                        <template x-for="food in searchResults.slice(0, 15)" :key="food.name">
                            <li class="modal-food-item">
                                <input 
                                    type="checkbox" 
                                    :id="'food-'+food.name" 
                                    :checked="addFoodContext === 'diet' ? 
                                        (selectedDiet && selectedDiet.foods.some(f => f.foodName === food.name)) :
                                        storedFoods.some(f => f.name === food.name)"
                                    @change="toggleFoodSelection(food)"
                                    class="mr-3"
                                >
                                <label :for="'food-'+food.name" x-text="food.name" class="flex-1 modal-label"></label>
                            </li>
                        </template>
                        <template x-if="searchResults.length === 0">
                            <li class="p-4 text-gray-500">No foods found.</li>
                        </template>
                    </ul>
                </div>
                <div class="items-center px-4 py-3">
                    <button @click="isAddingFood = false; addFoodContext = null" class="blue-btn bg-gray-500 hover:bg-gray-600 w-full">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Nutrient Column Modal -->
    <div x-show="isAddingColumn" @keydown.escape.window="isAddingColumn = false" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="isAddingColumn = false" class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add Nutrient Column</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" x-model="nutrientSearchQuery" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Search for a nutrient...">
                </div>
                <div class="max-h-60 overflow-y-auto border rounded-md">
                    <ul class="divide-y divide-gray-200">
                        <template x-for="nutrient in filteredAvailableNutrients" :key="nutrient">
                            <li class="modal-food-item">
                                <input 
                                    type="checkbox" 
                                    :id="'nutrient-'+nutrient" 
                                    :checked="displayHeaders.includes(nutrient)"
                                    @change="toggleNutrientColumn(nutrient)"
                                    class="mr-3"
                                >
                                <label :for="'nutrient-'+nutrient" x-text="nutrient" class="flex-1 modal-label"></label>
                            </li>
                        </template>
                        <template x-if="filteredAvailableNutrients.length === 0">
                            <li class="p-4 text-gray-500">No available nutrients found.</li>
                        </template>
                    </ul>
                </div>
                <div class="items-center px-4 py-3">
                    <button @click="isAddingColumn = false" class="blue-btn bg-gray-500 hover:bg-gray-600 w-full">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nutrient Contribution Pie Chart Modal -->
    <div x-show="showNutrientChart" @keydown.escape.window="showNutrientChart = false" 
         class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium mb-4" x-text="'Contribution to ' + selectedNutrient"></h3>
            <div class="chart-container">
                <canvas id="nutrientChart" width="400" height="400"></canvas>
            </div>
            <button @click="showNutrientChart = false" class="mt-4 blue-btn w-full">Close</button>
        </div>
    </div>

    <!-- Suggest Food Modal -->
    <div x-show="showSuggestModal" @keydown.escape.window="showSuggestModal = false" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="showSuggestModal = false" class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Suggested Foods</h3>
                <div class="mt-4 max-h-60 overflow-y-auto border rounded-md">
                    <ul class="divide-y divide-gray-200">
                        <template x-for="food in suggestedFoods" :key="food.name">
                            <li class="flex justify-between items-center p-3 hover:bg-gray-50">
                                <span x-text="food.name"></span>
                                <button @click="addSuggestedFood(food)" class="blue-btn text-xs px-3 py-1">Add</button>
                            </li>
                        </template>
                        <template x-if="suggestedFoods.length === 0">
                            <li class="p-4 text-gray-500">No suggestions available. Add foods to your diet first.</li>
                        </template>
                    </ul>
                </div>
                <div class="items-center px-4 py-3">
                    <button @click="showSuggestModal = false" class="blue-btn bg-gray-500 hover:bg-gray-600 w-full">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function foodApp() {
            return {
                // --- STATE ---
                allFoods: [],
                storedFoods: [],
                nutrientHeaders: [],
                nutrientTreeNames: [], // Store all nutrient names from nutrientTree.txt
                displayHeaders: ['name'],
                searchQuery: '',
                searchResults: [],
                isLoading: false,
                isCreatingFood: false,
                newFood: {},
                sortColumn: 'name',
                sortDirection: 'asc',
                activeTab: 'foods',
                nutrientTargets: {},
                isAddingColumn: false,
                isAddingFood: false,
                nutrientSearchQuery: '',
                addFoodContext: null, // 'diet', 'tracker', or null
                defaultNutrientTargets: {},
                
                // Diets state
                diets: [],
                selectedDiet: null,
                
                // Tracker state
                trackerDate: new Date().toISOString().split('T')[0],
                trackedFoods: [],
                
                // Chart state
                showNutrientChart: false,
                selectedNutrient: '',
                nutrientChart: null,

                // Suggest Food state
                showSuggestModal: false,
                suggestedFoods: [],

                // --- COMPUTED PROPERTIES ---
                get sortedStoredFoods() {
                    return [...this.storedFoods].sort((a, b) => {
                        let valA = a[this.sortColumn];
                        let valB = b[this.sortColumn];
                        if (typeof valA === 'string') {
                            valA = valA.toLowerCase();
                            valB = valB.toLowerCase();
                        }
                        if (valA < valB) return this.sortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return this.sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                },
                get filteredAvailableNutrients() {
                    if (!this.nutrientTreeNames || !this.nutrientHeaders) {
                        return [];
                    }

                    const availableNutrients = this.nutrientTreeNames.filter(h => 
                        this.nutrientHeaders.includes(h)
                    );
                    const uniqueAvailableNutrients = [...new Set(availableNutrients)];

                    if (!this.nutrientSearchQuery) {
                        return uniqueAvailableNutrients;
                    }

                    return uniqueAvailableNutrients.filter(h => {
                        return h.toLowerCase().includes(this.nutrientSearchQuery.toLowerCase());
                    });
                },

                // --- METHODS ---
                async init() {
                    this.defaultNutrientTargets = {};
                    this.storedFoods = JSON.parse(localStorage.getItem('storedFoods')) || [];
                    this.diets = JSON.parse(localStorage.getItem('diets')) || [];
                    this.trackedFoods = JSON.parse(localStorage.getItem('trackedFoods')) || [];
                    this.isLoading = true;
                    await Promise.all([this.loadNutrientTree(), this.loadFoodData()]);
                    this.isLoading = false;
                    
                    // Load nutrient targets with default values
                    const storedTargets = JSON.parse(localStorage.getItem('nutrientTargets')) || {};
                    this.nutrientTargets = { ...this.defaultNutrientTargets, ...storedTargets };
                    this.saveTargets();
                    
                    this.$watch('searchQuery', () => {
                        this.searchFoods();
                    });
                    
                    // Watch nutrientTargets and save automatically
                    this.$watch('nutrientTargets', () => {
                        this.saveTargets();
                    }, { deep: true });
                    
                    // Watch trackedFoods and save automatically
                    this.$watch('trackedFoods', () => {
                        localStorage.setItem('trackedFoods', JSON.stringify(this.trackedFoods));
                    }, { deep: true });
                },

                async loadNutrientTree() {
                    try {
                        const response = await fetch('nutrientTree.txt');
                        if (!response.ok) throw new Error('nutrientTree.txt not found');
                        const lines = (await response.text()).split('\n');
                        const allNutrients = [];
                        const defaultDisplayNutrients = [];

                        lines.forEach(line => {
                            const trimmedLine = line.trim();
                            if (trimmedLine.startsWith('+')) {
                                const content = trimmedLine.substring(1).trim();
                                // Split by dash characters to capture default value
                                const parts = content.split(/‚Äî/).map(part => part.trim());
                                let nutrientName = parts[0];
                                let defaultValue = null;
                                if (parts.length > 1) {
                                    // Try to parse the second part as a number
                                    defaultValue = parseFloat(parts[1]);
                                    if (!isNaN(defaultValue)) {
                                        // Store in defaultNutrientTargets
                                        this.defaultNutrientTargets[nutrientName] = defaultValue;
                                    }
                                }
                                defaultDisplayNutrients.push(nutrientName);
                                allNutrients.push(nutrientName);
                            } else if (trimmedLine) {
                                // Non-default nutrient (without +) - just add the name
                                allNutrients.push(trimmedLine);
                            }
                        });
                        
                        this.nutrientTreeNames = allNutrients;
                        this.displayHeaders = ['name', ...defaultDisplayNutrients];
                    } catch (error) {
                        console.error('Failed to load or parse nutrientTree.txt:', error);
                    }
                },

                async loadFoodData() {
                    try {
                        const response = await fetch('foodnutrient.json');
                        if (!response.ok) throw new Error('foodnutrient.json not found');
                        const foodData = await response.json();
                        
                        if (!Array.isArray(foodData)) {
                            throw new Error('Invalid JSON format');
                        }
                        
                        // Extract headers: all keys except 'food'
                        const nutrientHeaders = [];
                        foodData.forEach(food => {
                            Object.keys(food).forEach(key => {
                                if (key !== 'food' && !nutrientHeaders.includes(key)) {
                                    nutrientHeaders.push(key);
                                }
                            });
                        });
                        
                        this.nutrientHeaders = ['name', ...nutrientHeaders];
                        
                        // Transform data to match previous structure
                        this.allFoods = foodData.map(food => {
                            const foodObj = { name: food.food || '' };
                            nutrientHeaders.forEach(nutrient => {
                                foodObj[nutrient] = parseFloat(food[nutrient]) || 0;
                            });
                            return foodObj;
                        });
                        
                        // Ensure display headers are set
                        if (this.displayHeaders.length <= 1) {
                            this.displayHeaders = this.nutrientHeaders;
                        }
                    } catch (error) {
                        console.error('Error loading food data:', error);
                        alert('Error: Could not load or parse food data. Please make sure the foodnutrient.json file is present and valid.');
                    }
                },

                searchFoods() {
                    // Determine which food source to use based on context
                    const source = this.addFoodContext === 'diet' || this.addFoodContext === 'tracker' ? this.storedFoods : this.allFoods;
                    
                    if (this.searchQuery === '') {
                        this.searchResults = source;
                    } else {
                        this.searchResults = source.filter(food => 
                            food.name.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );
                    }
                },

                addFood(foodObject) {
                    if (this.storedFoods.some(food => food.name === foodObject.name)) {
                        // Food already exists, don't add duplicate
                        return;
                    }
                    this.storedFoods.push(foodObject);
                    this.saveStoredFoods();
                },

                removeFood(name) {
                    this.storedFoods = this.storedFoods.filter(food => food.name !== name);
                    this.saveStoredFoods();
                    
                    // Remove from all diets
                    this.diets.forEach(diet => {
                        diet.foods = diet.foods.filter(foodItem => foodItem.foodName !== name);
                    });
                    this.saveDiets();
                    
                    // Remove from tracked foods
                    this.trackedFoods = this.trackedFoods.filter(foodItem => foodItem.foodName !== name);
                },

                clearAll() {
                    if (confirm('Are you sure you want to remove all foods from your list?')) {
                        this.storedFoods = [];
                        this.saveStoredFoods();
                        
                        // Remove all foods from diets
                        this.diets.forEach(diet => {
                            diet.foods = [];
                        });
                        this.saveDiets();
                        
                        // Remove all tracked foods
                        this.trackedFoods = [];
                    }
                },

                showCreateFoodRow() {
                    this.isCreatingFood = true;
                    this.newFood = {};
                },

                saveNewFood() {
                    const name = (this.newFood.name || '').trim();
                    if (!name) {
                        alert('Food name cannot be empty.');
                        return;
                    }
                    if (this.storedFoods.some(food => food.name.toLowerCase() === name.toLowerCase())) {
                        alert('A food with this name already exists.');
                        return;
                    }
                    
                    const completeNewFood = {};
                    this.nutrientHeaders.forEach(h => {
                        completeNewFood[h] = this.newFood[h] || 0;
                    });
                    completeNewFood.name = name;

                    this.storedFoods.unshift(completeNewFood);
                    this.saveStoredFoods();
                    this.cancelNewFood();
                },

                cancelNewFood() {
                    this.isCreatingFood = false;
                    this.newFood = {};
                },

                changeSort(column) {
                    if (this.sortColumn === column) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortColumn = column;
                        this.sortDirection = 'asc';
                    }
                },
                
                addNutrientColumn(nutrient) {
                    if (!this.displayHeaders.includes(nutrient)) {
                        this.displayHeaders.push(nutrient);
                    }
                    this.nutrientSearchQuery = '';
                },

                removeNutrientColumn(nutrient) {
                    this.displayHeaders = this.displayHeaders.filter(h => h !== nutrient);
                    delete this.nutrientTargets[nutrient];
                },

                saveTargets() {
                    localStorage.setItem('nutrientTargets', JSON.stringify(this.nutrientTargets));
                },
                
                saveStoredFoods() {
                    localStorage.setItem('storedFoods', JSON.stringify(this.storedFoods));
                },
                
                // Diets methods
                createDiet() {
                    const dietNumber = this.diets.length + 1;
                    const newDiet = {
                        id: Date.now().toString(),
                        name: `Diet ${dietNumber}`,
                        foods: []
                    };
                    
                    this.diets.push(newDiet);
                    this.saveDiets();
                },
                
                deleteDiet(id) {
                    if (confirm('Are you sure you want to delete this diet?')) {
                        this.diets = this.diets.filter(diet => diet.id !== id);
                        if (this.selectedDiet && this.selectedDiet.id === id) {
                            this.selectedDiet = null;
                        }
                        this.saveDiets();
                    }
                },
                
                selectDiet(diet) {
                    this.selectedDiet = diet;
                },
                
                addFoodToDiet(foodName) {
                    // Check if food already exists in diet
                    const existingIndex = this.selectedDiet.foods.findIndex(f => f.foodName === foodName);
                    if (existingIndex >= 0) {
                        // Update existing quantity
                        this.selectedDiet.foods[existingIndex].quantity += 100;
                    } else {
                        // Add new food with default quantity and unlocked state
                        this.selectedDiet.foods.push({
                            foodName,
                            quantity: 100,
                            locked: false
                        });
                    }
                    
                    this.saveDiets();
                },
                
                removeFoodFromDiet(foodName) {
                    this.selectedDiet.foods = this.selectedDiet.foods.filter(f => f.foodName !== foodName);
                    this.saveDiets();
                },
                
                saveDiets() {
                    localStorage.setItem('diets', JSON.stringify(this.diets));
                },
                
                // Calculate total nutrient amount for the diet
                calculateNutrientTotal(nutrient) {
                    if (!this.selectedDiet) return 0;
                    
                    let total = 0;
                    for (const foodItem of this.selectedDiet.foods) {
                        const food = this.storedFoods.find(f => f.name === foodItem.foodName);
                        if (food && food[nutrient] !== undefined) {
                            // Calculate: (nutrient per 100g) * (quantity in grams) / 100
                            total += (food[nutrient] * foodItem.quantity) / 100;
                        }
                    }
                    return total;
                },
                
                // Calculate nutrient percentage of target
                calculateNutrientPercentage(nutrient) {
                    const total = this.calculateNutrientTotal(nutrient);
                    const target = this.nutrientTargets[nutrient] || 0;
                    
                    if (target <= 0) return 0;
                    
                    return (total / target) * 100;
                },
                
                // Optimize diet to hit nutrient targets
                optimizeDiet() {
                    if (!this.selectedDiet || this.selectedDiet.foods.length === 0) {
                        alert("Please add foods to the diet first.");
                        return;
                    }
                    
                    // Get nutrients that have targets > 0
                    const nutrients = this.displayHeaders.filter(h => 
                        h !== 'name' && 
                        this.nutrientTargets[h] > 0 &&
                        this.selectedDiet.foods.some(foodItem => {
                            const food = this.storedFoods.find(f => f.name === foodItem.foodName);
                            return food && food[h] !== undefined;
                        })
                    );
                    
                    if (nutrients.length === 0) {
                        alert("Please set targets for at least one nutrient in the Nutrient Targets tab.");
                        return;
                    }
                    
                    // Get foods in the diet
                    const foods = this.selectedDiet.foods.map(foodItem => {
                        return this.storedFoods.find(f => f.name === foodItem.foodName);
                    }).filter(Boolean);
                    
                    if (foods.length === 0) {
                        alert("No valid foods found in the diet.");
                        return;
                    }
                    
                    try {
                        // Separate locked and unlocked foods
                        const lockedFoods = [];
                        const unlockedFoods = [];
                        const lockedQuantities = [];
                        
                        for (let i = 0; i < this.selectedDiet.foods.length; i++) {
                            const foodItem = this.selectedDiet.foods[i];
                            if (foodItem.locked) {
                                lockedFoods.push(foods[i]);
                                lockedQuantities.push(foodItem.quantity);
                            } else {
                                unlockedFoods.push(foods[i]);
                            }
                        }
                        
                        // Calculate locked nutrients contribution
                        const lockedNutrients = math.zeros(nutrients.length).toArray();
                        for (let i = 0; i < nutrients.length; i++) {
                            const nutrient = nutrients[i];
                            let total = 0;
                            for (let j = 0; j < lockedFoods.length; j++) {
                                const food = lockedFoods[j];
                                const valuePerGram = (food[nutrient] || 0) / 100;
                                total += valuePerGram * lockedQuantities[j];
                            }
                            lockedNutrients[i] = total;
                        }
                        
                        // Build the A matrix for unlocked foods: nutrients x foods
                        const A = [];
                        for (let i = 0; i < nutrients.length; i++) {
                            const nutrient = nutrients[i];
                            const target = this.nutrientTargets[nutrient];
                            const row = [];
                            for (const food of unlockedFoods) {
                                // Nutrient value per gram = (value per 100g) / 100
                                const valuePerGram = (food[nutrient] || 0) / 100;
                                row.push(valuePerGram / target);
                            }
                            A.push(row);
                        }
                        
                        // Vector b: (1 - lockedNutrients[i]/target) for each nutrient
                        const b = [];
                        for (let i = 0; i < nutrients.length; i++) {
                            const nutrient = nutrients[i];
                            const target = this.nutrientTargets[nutrient];
                            const lockedContribution = lockedNutrients[i] / target;
                            b.push(1 - lockedContribution);
                        }
                        
                        // Solve least squares: minimize ||A*x - b||
                        const x = math.lusolve(math.multiply(math.transpose(A), A), 
                                              math.multiply(math.transpose(A), b));
                        
                        // Extract solution
                        const solution = x.flat();
                        
                        // Update quantities for unlocked foods
                        let unlockedIndex = 0;
                        for (let i = 0; i < this.selectedDiet.foods.length; i++) {
                            const foodItem = this.selectedDiet.foods[i];
                            if (!foodItem.locked) {
                                const quantity = Math.max(0, solution[unlockedIndex]);
                                foodItem.quantity = Math.round(quantity);
                                unlockedIndex++;
                            }
                        }
                        
                        this.saveDiets();
                        if(solution.some(x=>x<0)){
                            let unlockedIndex = 0;
                            const foodsToLock = [];
                            
                            for (let i = 0; i < this.selectedDiet.foods.length; i++) {
                                const foodItem = this.selectedDiet.foods[i];
                                if (!foodItem.locked) {
                                    if (solution[unlockedIndex] < 0) {
                                        foodsToLock.push(i);
                                        foodItem.locked = true;
                                    }
                                    unlockedIndex++;
                                }
                            }
                            
                            this.optimizeDiet();

                            foodsToLock.forEach(i => {this.selectedDiet.foods[i].locked = false;});
                        }
                    } catch (error) {
                        console.error("Optimization error:", error);
                        alert("Failed to optimize diet.");
                    }
                },
                
                // Create new food from search query
                createNewFoodFromSearch() {
                    const name = this.searchQuery.trim();
                    if (!name) {
                        alert('Please enter a food name');
                        return;
                    }
                    
                    if (this.storedFoods.some(food => food.name.toLowerCase() === name.toLowerCase())) {
                        alert('A food with this name already exists.');
                        return;
                    }
                    
                    // Create a new food with all nutrients set to 0
                    const newFood = { name };
                    this.nutrientHeaders.forEach(header => {
                        if (header !== 'name') {
                            newFood[header] = 0;
                        }
                    });
                    
                    // Add to stored foods
                    this.storedFoods.push(newFood);
                    this.saveStoredFoods();
                    
                    // If in diet context, also add to diet
                    if (this.addFoodContext === 'diet' && this.selectedDiet) {
                        this.addFoodToDiet(name);
                    }
                    
                    // If in tracker context, also add to tracked foods
                    if (this.addFoodContext === 'tracker') {
                        this.addTrackedFood(name);
                    }
                    
                    // Clear search and close modal
                    this.searchQuery = '';
                    this.isAddingFood = false;
                },

                // Toggle food selection in modal
                toggleFoodSelection(food) {
                    if (this.addFoodContext === 'diet') {
                        if (this.selectedDiet.foods.some(f => f.foodName === food.name)) {
                            this.removeFoodFromDiet(food.name);
                        } else {
                            this.addFoodToDiet(food.name);
                        }
                    } else if (this.addFoodContext === 'tracker') {
                        if (this.trackedFoods.some(f => f.foodName === food.name)) {
                            this.removeTrackedFood(food.name);
                        } else {
                            this.addTrackedFood(food.name);
                        }
                    } else {
                        if (this.storedFoods.some(f => f.name === food.name)) {
                            this.removeFood(food.name);
                        } else {
                            this.addFood(food);
                        }
                    }
                },
                
                // Toggle nutrient column in modal
                toggleNutrientColumn(nutrient) {
                    if (this.displayHeaders.includes(nutrient)) {
                        this.removeNutrientColumn(nutrient);
                    } else {
                        this.addNutrientColumn(nutrient);
                    }
                },
                
                // Reset food modal when opened
                resetFoodModal() {
                    this.searchQuery = '';
                    this.searchResults = [];
                },
                
                // Open food modal with reset
                openAddFoodModal() {
                    this.resetFoodModal();
                    this.isAddingFood = true;
                },
                
                // Open nutrient modal with reset
                openAddNutrientModal() {
                    this.nutrientSearchQuery = '';
                    this.isAddingColumn = true;
                },
                
                // Tracker methods
                addTrackedFood(foodName) {
                    // Check if food already exists in tracker
                    const existingIndex = this.trackedFoods.findIndex(f => f.foodName === foodName);
                    if (existingIndex >= 0) {
                        // Update existing quantity
                        this.trackedFoods[existingIndex].quantity += 100;
                    } else {
                        // Add new food with default quantity
                        this.trackedFoods.push({
                            foodName,
                            quantity: 100
                        });
                    }
                },
                
                removeTrackedFood(foodName) {
                    this.trackedFoods = this.trackedFoods.filter(f => f.foodName !== foodName);
                },
                
                // Calculate daily nutrient intake
                calculateDailyIntake(nutrient) {
                    let total = 0;
                    for (const foodItem of this.trackedFoods) {
                        const food = this.storedFoods.find(f => f.name === foodItem.foodName);
                        if (food && food[nutrient] !== undefined) {
                            // Calculate: (nutrient per 100g) * (quantity in grams) / 100
                            total += (food[nutrient] * foodItem.quantity) / 100;
                        }
                    }
                    return total;
                },
                
                // Show nutrient contribution pie chart
                showNutrientContribution(nutrient) {
                    this.selectedNutrient = nutrient;
                    this.showNutrientChart = true;
                    
                    this.$nextTick(() => {
                        this.renderNutrientChart(nutrient);
                    });
                },
                
                renderNutrientChart(nutrient) {
                    if (this.nutrientChart) {
                        this.nutrientChart.destroy();
                    }
                    
                    const ctx = document.getElementById('nutrientChart').getContext('2d');
                    const contributions = [];
                    const labels = [];
                    let otherTotal = 0;
                    
                    // Calculate contributions
                    this.selectedDiet.foods.forEach(foodItem => {
                        const food = this.storedFoods.find(f => f.name === foodItem.foodName);
                        if (food && food[nutrient]) {
                            const contribution = (food[nutrient] * foodItem.quantity) / 100;
                            
                            // Group small contributions as "Other"
                            if (contribution < (this.calculateNutrientTotal(nutrient) * 0.05)) {
                                otherTotal += contribution;
                            } else {
                                contributions.push(contribution);
                                labels.push(food.name);
                            }
                        }
                    });
                    
                    // Add "Other" category if needed
                    if (otherTotal > 0) {
                        contributions.push(otherTotal);
                        labels.push('Other');
                    }
                    
                    // Sort contributions from largest to smallest
                    const combined = contributions.map((value, index) => ({ value, label: labels[index] }));
                    combined.sort((a, b) => b.value - a.value);
                    
                    const sortedContributions = combined.map(item => item.value);
                    const sortedLabels = combined.map(item => item.label);
                    
                    this.nutrientChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: sortedLabels,
                            datasets: [{
                                data: sortedContributions,
                                backgroundColor: [
                                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                                    '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.label}: ${context.raw.toFixed(2)}`;
                                        }
                                    }
                                },
                                legend: {
                                    position: 'bottom',
                                    align: 'start' // Left align legend
                                }
                            }
                        }
                    });
                },
                
                // Suggest food method
                suggestFood() {
                    if (!this.selectedDiet || this.selectedDiet.foods.length === 0) {
                        alert("Please add foods to your diet first.");
                        return;
                    }

                    const nutrients = this.displayHeaders.filter(
                        h => h !== 'name' && 
                        this.nutrientTargets[h] > 0
                    );

                    if (nutrients.length === 0) {
                        alert("Please set nutrient targets first.");
                        return;
                    }

                    // Compute diet vector D
                    const D = [];
                    for (const nutrient of nutrients) {
                        const total = this.calculateNutrientTotal(nutrient);
                        D.push(total / this.nutrientTargets[nutrient]);
                    }

                    const mD = math.mean(D);
                    const mD2 = math.mean(math.dotPow(D, 2));

                    const foodScores = [];
                    
                    for (const food of this.allFoods) {
                        // Skip foods already in diet
                        if (this.selectedDiet.foods.some(f => f.foodName === food.name)) continue;
                        
                        // Compute food vector F
                        const F = nutrients.map(nutrient => (food[nutrient] || 0) / 100);
                        const mF = math.mean(F);
                        const mF2 = math.mean(math.dotPow(F, 2));
                        const mFD = math.mean(math.dotMultiply(F, D));
                        
                        // Compute score
                        const numerator = mF2 * mD**2 + mD2 * mF**2 - 2 * mFD * mF * mD;
                        const denominator = mF2 * mD2 - mFD**2;
                        const optimalAmount = (mF * mD2 - mD * mFD) * denominator; //we only care about the sign
                        const score = (optimalAmount>0)? numerator / denominator : -Infinity;
                        
                        foodScores.push({ food, score });
                    }

                    // Sort by highest score and take top 5
                    foodScores.sort((a, b) => b.score - a.score);
                    this.suggestedFoods = foodScores.slice(0, 5).map(item => item.food);
                    this.showSuggestModal = true;
                },
                
                // Add suggested food to diet
                addSuggestedFood(food) {
                    // Add to stored foods if not already present
                    if (!this.storedFoods.some(f => f.name === food.name)) {
                        this.storedFoods.push(food);
                        this.saveStoredFoods();
                    }
                    
                    // Add to diet
                    this.addFoodToDiet(food.name);
                    this.showSuggestModal = false;
                }
            }
        }
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Nutrient Finder</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçé</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Alpine.js for interactivity -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        [x-cloak] { display: none !important; }
        .sort-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-left: 0.5rem;
            color: #9ca3af;
            transition: color 0.2s;
        }
        th:hover .sort-icon {
            color: #374151;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #1e40af; /* blue-800 */
            font-weight: 600;
        }
        .remove-icon {
            cursor: pointer;
            color: #ef4444; /* red-500 */
            font-weight: bold;
            padding-right: 0.75rem;
            font-size: 1.25rem; /* Larger remove icon */
        }
        .remove-icon:hover {
            color: #b91c1c; /* red-700 */
        }
        #search-results, .modal {
            z-index: 20;
        }
        #table-container {
            overflow-x: auto;
        }
        .sticky-col {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            left: 0;
            z-index: 10;
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #nutrient-table thead .sticky-col {
            background-color: #f3f4f6; /* gray-100, same as thead */
        }
        #nutrient-table tbody tr .sticky-col {
            background-color: #ffffff; /* white, same as row */
        }
        .text-zero {
            color: #d1d5db; /* gray-300 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 text-base" x-data="foodApp()" x-init="init()" x-cloak>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Food Nutrient Finder <sup class="text-lg font-medium text-gray-400">v0.5</sup></h1>
            <p class="text-base sm:text-lg text-gray-600 mt-2">Search, track, and manage your nutritional intake.</p>
        </header>

        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-4 sm:space-x-8 overflow-x-auto" aria-label="Tabs">
                <button @click="activeTab = 'foods'" :class="{'active': activeTab === 'foods'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Foods</button>
                <button @click="activeTab = 'targets'" :class="{'active': activeTab === 'targets'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Nutrient Targets</button>
                <button @click="activeTab = 'diets'" :class="{'active': activeTab === 'diets'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Diets</button>
            </nav>
        </div>

        <!-- Foods Tab -->
        <div id="content-foods" class="tab-content" x-show="activeTab === 'foods'">
            <div class="relative mb-4" @click.outside="searchResults = []">
                <input type="text" x-model.debounce.300ms="searchQuery" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base" placeholder="Search for a food...">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center" :class="{'hidden': !isLoading}">
                    <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </div>
            </div>

            <div id="search-results" class="absolute w-full md:w-1/2 bg-white border border-gray-200 rounded-lg shadow-lg mt-1" x-show="searchResults.length > 0 && searchQuery.length > 1">
                <ul class="max-h-80 overflow-y-auto">
                    <template x-for="food in searchResults.slice(0, 15)" :key="food.description">
                        <li class="p-3 border-b border-gray-100 flex justify-between items-center">
                            <span x-text="food.description" class="text-sm text-gray-800 mr-2"></span>
                            <button @click="addFood(food)" class="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-full hover:bg-blue-600">Add</button>
                        </li>
                    </template>
                </ul>
            </div>

            <div class="mt-12">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                     <h2 class="text-2xl font-semibold text-gray-800">My Foods</h2>
                     <div class="flex gap-2">
                        <button @click="isAddingColumn = true" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Add Nutrient Column</button>
                        <button @click="showCreateFoodRow()" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Create New Food</button>
                     </div>
                </div>
                <div id="table-container" class="bg-white rounded-lg shadow" x-show="storedFoods.length > 0 || isCreatingFood">
                    <table id="nutrient-table" class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <template x-for="header in displayHeaders" :key="header">
                                    <th scope="col" class="px-6 py-2 cursor-pointer text-xs" :class="{'sticky-col': header === 'description'}" @click="changeSort(header)">
                                        <span x-text="header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
                                        <span class="sort-icon" x-html="sortColumn === header ? (sortDirection === 'asc' ? '&#9650;' : '&#9660;') : ''"></span>
                                    </th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="isCreatingFood">
                                <tr id="new-food-row" class="bg-gray-50">
                                    <template x-for="header in displayHeaders" :key="header">
                                        <td class="p-1">
                                            <input :type="header === 'description' ? 'text' : 'number'" :placeholder="header.replace(/_/g, ' ')" x-model="newFood[header]" class="w-full p-2 border rounded-md text-sm">
                                        </td>
                                    </template>
                                    <td class="p-1 whitespace-nowrap">
                                        <button @click="saveNewFood()" class="px-3 py-1 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600">Save</button>
                                        <button @click="cancelNewFood()" class="ml-2 px-3 py-1 bg-gray-500 text-white text-xs rounded-md hover:bg-gray-600">Cancel</button>
                                    </td>
                                </tr>
                            </template>
                            <template x-for="food in sortedStoredFoods" :key="food.description">
                                <tr class="bg-white border-b">
                                    <template x-for="header in displayHeaders" :key="header">
                                        <td :class="{
                                            'px-6 py-4 font-medium text-gray-900 sticky-col text-sm': header === 'description',
                                            'px-6 py-4 text-sm': header !== 'description',
                                            'text-zero': typeof food[header] === 'number' && food[header] === 0
                                        }" :title="food[header]">
                                            <template x-if="header === 'description'">
                                                <div>
                                                    <span @click="removeFood(food.description)" class="remove-icon">&times;</span>
                                                    <span x-text="food[header]"></span>
                                                </div>
                                            </template>
                                            <template x-if="header !== 'description'">
                                                <span x-text="typeof food[header] === 'number' ? food[header].toFixed(2) : (food[header] || '0.00')"></span>
                                            </template>
                                        </td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div id="table-placeholder" class="text-center p-8 text-gray-500" x-show="storedFoods.length === 0 && !isCreatingFood">
                    <p>Your added foods will appear here.</p>
                </div>
                <button @click="clearAll()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" :disabled="storedFoods.length === 0">Clear All Foods</button>
            </div>
        </div>

        <!-- Nutrient Targets Tab -->
        <div id="content-targets" class="tab-content p-6 bg-white rounded-lg shadow" x-show="activeTab === 'targets'">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Nutrient Targets</h2>
            <div id="targets-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4">
                <template x-for="nutrient in displayHeaders.filter(h => h !== 'description')" :key="nutrient">
                    <div class="flex items-center justify-between">
                        <label :for="`target-${nutrient}`" x-text="nutrient.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())" class="text-sm font-medium text-gray-700"></label>
                        <input type="number" :id="`target-${nutrient}`" x-model.number="nutrientTargets[nutrient]" class="w-32 p-2 border rounded-md text-sm" placeholder="0.00">
                    </div>
                </template>
            </div>
            <div class="mt-8 text-right">
                <button @click="saveTargets()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save Targets</button>
            </div>
        </div>

        <!-- Diets Tab -->
        <div id="content-diets" class="tab-content p-6" x-show="activeTab === 'diets'">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Diets</h2>
            <p class="text-lg">This section is under construction. Here you will be able to create and manage different diets.</p>
        </div>
    </div>

    <!-- Add Column Modal -->
    <div x-show="isAddingColumn" @keydown.escape.window="isAddingColumn = false" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="isAddingColumn = false" class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add Nutrient Column</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" x-model="nutrientSearchQuery" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Search for a nutrient...">
                </div>
                <div class="max-h-60 overflow-y-auto border rounded-md">
                    <ul class="divide-y divide-gray-200">
                        <template x-for="nutrient in filteredAvailableNutrients" :key="nutrient">
                             <li class="p-3 flex justify-between items-center text-sm">
                                <span x-text="nutrient.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
                                <button @click="addNutrientColumn(nutrient)" class="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-full hover:bg-blue-600">Add</button>
                            </li>
                        </template>
                        <template x-if="filteredAvailableNutrients.length === 0">
                            <li class="p-4 text-gray-500">No available nutrients found.</li>
                        </template>
                    </ul>
                </div>
                <div class="items-center px-4 py-3">
                    <button @click="isAddingColumn = false" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        function foodApp() {
            return {
                // --- STATE ---
                allFoods: [],
                storedFoods: [],
                nutrientHeaders: [],
                displayHeaders: ['description'],
                searchQuery: '',
                searchResults: [],
                isLoading: false,
                isCreatingFood: false,
                newFood: {},
                sortColumn: 'description',
                sortDirection: 'asc',
                activeTab: 'foods',
                nutrientTargets: {},
                isAddingColumn: false,
                nutrientSearchQuery: '',

                // --- COMPUTED PROPERTIES ---
                get sortedStoredFoods() {
                    return [...this.storedFoods].sort((a, b) => {
                        let valA = a[this.sortColumn];
                        let valB = b[this.sortColumn];
                        if (typeof valA === 'string') {
                            valA = valA.toLowerCase();
                            valB = valB.toLowerCase();
                        }
                        if (valA < valB) return this.sortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return this.sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                },
                get filteredAvailableNutrients() {
                    if (!this.nutrientSearchQuery) {
                        return this.nutrientHeaders.filter(h => h !== 'description' && !this.displayHeaders.includes(h));
                    }
                    return this.nutrientHeaders.filter(h => {
                        return h !== 'description' &&
                               !this.displayHeaders.includes(h) &&
                               h.toLowerCase().includes(this.nutrientSearchQuery.toLowerCase());
                    });
                },

                // --- METHODS ---
                async init() {
                    this.storedFoods = JSON.parse(localStorage.getItem('storedFoods')) || [];
                    this.nutrientTargets = JSON.parse(localStorage.getItem('nutrientTargets')) || {};
                    this.isLoading = true;
                    await Promise.all([this.loadNutrientTree(), this.loadFoodData()]);
                    this.isLoading = false;
                    this.$watch('searchQuery', () => {
                        this.searchFoods();
                    });
                },

                async loadNutrientTree() {
                    try {
                        const response = await fetch('nutrientTree.txt');
                        if (!response.ok) throw new Error('nutrientTree.txt not found');
                        const text = await response.text();
                        const treeNutrients = text.split('\n')
                            .map(line => line.trim())
                            .filter(line => line.startsWith('+'))
                            .map(line => line.substring(1).trim().toLowerCase());
                        this.displayHeaders = ['description', ...treeNutrients];
                    } catch (error) {
                        console.error('Failed to load or parse nutrientTree.txt:', error);
                    }
                },

                async loadFoodData() {
                    return new Promise((resolve, reject) => {
                        Papa.parse('foodnutrient.csv', {
                            download: true,
                            header: true,
                            skipEmptyLines: true,
                            transformHeader: header => header.toLowerCase() === 'food' ? 'description' : header.toLowerCase(),
                            complete: (results) => {
                                this.nutrientHeaders = results.meta.fields;
                                this.allFoods = results.data.map(row => {
                                    const food = {};
                                    this.nutrientHeaders.forEach(header => {
                                        if (header === 'description') {
                                            food[header] = row[header] || '';
                                        } else {
                                            food[header] = parseFloat(row[header]) || 0;
                                        }
                                    });
                                    return food;
                                });
                                if (this.displayHeaders.length <= 1) {
                                    this.displayHeaders = this.nutrientHeaders;
                                }
                                resolve();
                            },
                            error: (error) => {
                                console.error('Papa Parse Error:', error);
                                alert('Error: Could not load or parse food data. Please make sure the foodnutrient.csv file is present.');
                                reject(error);
                            }
                        });
                    });
                },

                searchFoods() {
                    if (this.searchQuery.length < 2) {
                        this.searchResults = [];
                        return;
                    }
                    this.searchResults = this.allFoods.filter(food => 
                        food.description.toLowerCase().includes(this.searchQuery.toLowerCase())
                    );
                },

                addFood(foodObject) {
                    if (this.storedFoods.some(food => food.description === foodObject.description)) {
                        alert('This food is already in your list.');
                        return;
                    }
                    this.storedFoods.push(foodObject);
                    this.saveStoredFoods();
                    this.searchQuery = '';
                    this.searchResults = [];
                },

                removeFood(description) {
                    this.storedFoods = this.storedFoods.filter(food => food.description !== description);
                    this.saveStoredFoods();
                },

                clearAll() {
                    if (confirm('Are you sure you want to remove all foods from your list?')) {
                        this.storedFoods = [];
                        this.saveStoredFoods();
                    }
                },

                showCreateFoodRow() {
                    this.isCreatingFood = true;
                    this.newFood = {};
                },

                saveNewFood() {
                    const name = (this.newFood.description || '').trim();
                    if (!name) {
                        alert('Food name cannot be empty.');
                        return;
                    }
                    if (this.storedFoods.some(food => food.description.toLowerCase() === name.toLowerCase())) {
                        alert('A food with this name already exists.');
                        return;
                    }
                    
                    const completeNewFood = {};
                    this.nutrientHeaders.forEach(h => {
                        completeNewFood[h] = this.newFood[h] || 0;
                    });
                    completeNewFood.description = name;

                    this.storedFoods.unshift(completeNewFood);
                    this.saveStoredFoods();
                    this.cancelNewFood();
                },

                cancelNewFood() {
                    this.isCreatingFood = false;
                    this.newFood = {};
                },

                changeSort(column) {
                    if (this.sortColumn === column) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortColumn = column;
                        this.sortDirection = 'asc';
                    }
                },
                
                addNutrientColumn(nutrient) {
                    if (!this.displayHeaders.includes(nutrient)) {
                        this.displayHeaders.push(nutrient);
                    }
                    this.nutrientSearchQuery = '';
                    // Optional: close modal after adding one
                    // this.isAddingColumn = false; 
                },

                saveTargets() {
                    localStorage.setItem('nutrientTargets', JSON.stringify(this.nutrientTargets));
                    alert('Nutrient targets saved!');
                },
                
                saveStoredFoods() {
                    localStorage.setItem('storedFoods', JSON.stringify(this.storedFoods));
                }
            }
        }
    </script>

</body>
</html>

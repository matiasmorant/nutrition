<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Nutrient Finder</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçé</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sort-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-left: 0.5rem;
            color: #9ca3af;
            transition: color 0.2s;
        }
        th:hover .sort-icon {
            color: #374151;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #1e40af; /* blue-800 */
            font-weight: 600;
        }
        .remove-icon {
            cursor: pointer;
            color: #ef4444; /* red-500 */
            font-weight: bold;
            padding-right: 0.75rem;
            font-size: 1.25rem; /* Larger remove icon */
        }
        .remove-icon:hover {
            color: #b91c1c; /* red-700 */
        }
        #search-results {
            z-index: 20; /* Ensure search results are above the sticky column */
        }

        /* Responsive Table to Card styles for mobile */
        @media (max-width: 768px) {
            #table-container {
                overflow-x: hidden; /* Prevent horizontal scroll on mobile */
            }
            #nutrient-table thead {
                display: none;
            }
            #nutrient-table, #nutrient-table tbody, #nutrient-table tr, #nutrient-table td {
                display: block;
                width: 100%;
            }
            #nutrient-table tr {
                margin-bottom: 1.5rem;
                border: 1px solid #e5e7eb; /* gray-200 */
                border-radius: 0.5rem;
                overflow: hidden;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            }
            #nutrient-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem 1.25rem; /* Increased padding */
                font-size: 1rem; /* Increased font size */
                text-align: right;
                border-bottom: 1px solid #f3f4f6; /* gray-100 */
            }
            #nutrient-table td:last-child {
                border-bottom: none;
            }
            #nutrient-table td::before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                padding-right: 1rem;
                color: #374151; /* gray-700 */
            }
            #nutrient-table td[data-label="Description"] {
                background-color: #f9fafb; /* gray-50 */
                font-size: 1.25rem; /* text-xl */
                font-weight: 600;
                padding: 1.25rem;
                flex-direction: row-reverse; /* Puts remove icon on the left */
                justify-content: flex-end;
            }
            #nutrient-table td[data-label="Description"]::before {
                display: none; /* Hide the "Description:" label itself */
            }
            #new-food-row {
                display: flex;
                flex-direction: column;
            }
        }

        /* Desktop table styles: sticky column and overflow */
        @media (min-width: 769px) {
            #table-container {
                overflow-x: auto;
            }
            .sticky-col {
                position: -webkit-sticky; /* For Safari */
                position: sticky;
                left: 0;
                z-index: 10;
            }
            #nutrient-table thead .sticky-col {
                background-color: #f3f4f6; /* gray-100, same as thead */
            }
            #nutrient-table tbody tr .sticky-col {
                background-color: #ffffff; /* white, same as row */
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 text-base">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-900">Food Nutrient Finder</h1>
            <p class="text-lg sm:text-xl text-gray-600 mt-2">Search, track, and manage your nutritional intake.</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-4 sm:space-x-8 overflow-x-auto" aria-label="Tabs">
                <button id="tab-foods" class="tab-btn active whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-lg">Foods</button>
                <button id="tab-targets" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">Nutrient Targets</button>
                <button id="tab-diets" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">Diets</button>
            </nav>
        </div>

        <!-- Tabs Content -->
        <div id="content-foods" class="tab-content">
            <!-- Search Bar -->
            <div class="relative mb-4">
                <input type="text" id="search-bar" class="w-full p-4 pl-12 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="Search for a food...">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                <div id="loading-spinner" class="absolute inset-y-0 right-0 pr-4 flex items-center hidden">
                    <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </div>
            </div>

            <!-- Search Results Dropdown -->
            <div id="search-results" class="absolute w-full md:w-1/2 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden"></div>

            <!-- Nutrient Table -->
            <div class="mt-12">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                     <h2 class="text-3xl font-semibold text-gray-800">My Foods</h2>
                     <button id="create-food-btn" class="w-full sm:w-auto px-5 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 text-lg">Create New Food</button>
                </div>
                <div id="table-container" class="bg-white rounded-lg shadow md:shadow-none md:bg-transparent">
                    <table id="nutrient-table" class="w-full text-base text-left text-gray-600">
                        <thead id="table-head" class="text-sm text-gray-700 uppercase bg-gray-100">
                            <!-- Headers will be injected here dynamically -->
                        </thead>
                        <tbody id="table-body">
                            <!-- Food rows will be injected here -->
                        </tbody>
                    </table>
                    <div id="table-placeholder" class="text-center p-8 text-lg text-gray-500 bg-white rounded-lg shadow md:shadow-none">
                        <p>Your added foods will appear here.</p>
                    </div>
                </div>
                <button id="clear-all-btn" class="mt-4 px-5 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 text-lg" disabled>Clear All Foods</button>
            </div>
        </div>

        <div id="content-targets" class="tab-content hidden p-6 bg-white rounded-lg shadow">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800">Nutrient Targets</h2>
            <div id="targets-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6">
                <!-- Nutrient target inputs will be injected here -->
            </div>
            <div class="mt-8 text-right">
                <button id="save-targets-btn" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 text-lg">Save Targets</button>
            </div>
        </div>

        <div id="content-diets" class="tab-content hidden p-6">
            <h2 class="text-3xl font-semibold mb-4 text-gray-800">Diets</h2>
            <p class="text-lg">This section is under construction. Here you will be able to create and manage different diets.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const searchBar = document.getElementById('search-bar');
            const searchResultsContainer = document.getElementById('search-results');
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');
            const tablePlaceholder = document.getElementById('table-placeholder');
            const nutrientTable = document.getElementById('nutrient-table');
            const loadingSpinner = document.getElementById('loading-spinner');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const createFoodBtn = document.getElementById('create-food-btn');
            const targetsListContainer = document.getElementById('targets-list');
            const saveTargetsBtn = document.getElementById('save-targets-btn');

            // --- STATE VARIABLES ---
            let allFoods = [];
            let storedFoods = JSON.parse(localStorage.getItem('storedFoods')) || [];
            let nutrientHeaders = [];
            let sortState = { column: 'description', direction: 'asc' };
            let searchTimeout;
            let isCreatingFood = false;

            // --- TABS FUNCTIONALITY ---
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const targetId = 'content-' + tab.id.split('-')[1];
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                        if (content.id === targetId) {
                            content.classList.remove('hidden');
                        }
                    });
                    if(tab.id === 'tab-targets') {
                        renderNutrientTargets();
                    }
                });
            });


            // --- DATA LOADING AND PARSING ---
            async function loadFoodData() {
                loadingSpinner.classList.remove('hidden');
                try {
                    const response = await fetch('foodnutrient.csv');
                    if (!response.ok) throw new Error('Network response was not ok. Make sure foodnutrient.csv is in the same folder.');
                    const csvText = await response.text();
                    parseCSV(csvText);
                    renderTableHeader();
                } catch (error) {
                    console.error('Failed to load or parse foodnutrient.csv:', error);
                    alert('Error: Could not load food data. Please make sure the foodnutrient.csv file is present.');
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }

            function parseCSV(text) {
                const lines = text.trim().split('\n');
                const headerLine = lines[0];
                nutrientHeaders = parseCsvLine(headerLine).map(h => h.toLowerCase() === 'food' ? 'description' : h.toLowerCase());
                if (nutrientHeaders.indexOf('description') === -1) throw new Error("CSV must have a 'food' column.");
                allFoods = lines.slice(1).map(line => {
                    const values = parseCsvLine(line);
                    const entry = {};
                    nutrientHeaders.forEach((header, index) => {
                        const value = values[index] || '';
                        entry[header] = header !== 'description' ? parseFloat(value) || 0 : value;
                    });
                    return entry;
                });
            }

            function parseCsvLine(line) {
                const values = [];
                let currentVal = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentVal.trim());
                        currentVal = '';
                    } else {
                        currentVal += char;
                    }
                }
                values.push(currentVal.trim());
                return values;
            }

            // --- SEARCH FUNCTIONALITY ---
            searchBar.addEventListener('keyup', () => {
                clearTimeout(searchTimeout);
                const query = searchBar.value.trim().toLowerCase();
                if (query.length < 2) {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                searchTimeout = setTimeout(() => {
                    const results = allFoods.filter(food => food.description.toLowerCase().includes(query));
                    displaySearchResults(results);
                }, 300);
            });
            
            document.addEventListener('click', (e) => {
                if (!searchBar.contains(e.target) && !searchResultsContainer.contains(e.target)) {
                    searchResultsContainer.classList.add('hidden');
                }
            });

            function displaySearchResults(foods) {
                searchResultsContainer.innerHTML = '';
                if (!foods || foods.length === 0) {
                    searchResultsContainer.innerHTML = `<div class="p-4 text-gray-500">No matches found.</div>`;
                    searchResultsContainer.classList.remove('hidden');
                    return;
                }
                const list = document.createElement('ul');
                list.className = 'max-h-80 overflow-y-auto';
                foods.slice(0, 15).forEach(food => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-3 border-b border-gray-100 flex justify-between items-center';
                    const foodDesc = document.createElement('span');
                    foodDesc.textContent = food.description;
                    foodDesc.className = 'text-base text-gray-800 mr-2';
                    const addButton = document.createElement('button');
                    addButton.textContent = 'Add';
                    addButton.className = 'px-3 py-1 bg-blue-500 text-white text-sm font-semibold rounded-full hover:bg-blue-600';
                    addButton.onclick = () => addFood(food);
                    listItem.appendChild(foodDesc);
                    listItem.appendChild(addButton);
                    list.appendChild(listItem);
                });
                searchResultsContainer.appendChild(list);
                searchResultsContainer.classList.remove('hidden');
            }

            // --- FOOD MANAGEMENT (ADD, CREATE) ---
            function addFood(foodObject) {
                if (storedFoods.some(food => food.description === foodObject.description)) {
                    alert('This food is already in your list.');
                    return;
                }
                storedFoods.push(foodObject);
                saveAndRender();
                searchResultsContainer.classList.add('hidden');
                searchBar.value = '';
            }

            createFoodBtn.addEventListener('click', () => {
                if (isCreatingFood) return;
                isCreatingFood = true;
                showCreateFoodRow();
            });

            function showCreateFoodRow() {
                const newRow = tableBody.insertRow(0);
                newRow.id = 'new-food-row';

                nutrientHeaders.forEach(header => {
                    const cell = newRow.insertCell();
                    cell.className = 'p-1';
                    const input = document.createElement('input');
                    input.type = header === 'description' ? 'text' : 'number';
                    input.placeholder = header.replace(/_/g, ' ');
                    input.className = 'w-full p-2 border rounded-md text-base';
                    input.dataset.header = header;
                    cell.appendChild(input);
                });

                const actionCell = newRow.insertCell();
                actionCell.className = 'p-1 whitespace-nowrap';
                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Save';
                saveBtn.className = 'px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600';
                saveBtn.onclick = saveNewFood;
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'ml-2 px-3 py-1 bg-gray-500 text-white text-sm rounded-md hover:bg-gray-600';
                cancelBtn.onclick = () => {
                    isCreatingFood = false;
                    renderTable();
                };

                actionCell.appendChild(saveBtn);
                actionCell.appendChild(cancelBtn);
            }

            function saveNewFood() {
                const newFood = {};
                const newRow = document.getElementById('new-food-row');
                const inputs = newRow.querySelectorAll('input');
                let isValid = true;

                inputs.forEach(input => {
                    const header = input.dataset.header;
                    if (header === 'description') {
                        if (input.value.trim() === '') {
                            alert('Food name cannot be empty.');
                            isValid = false;
                        }
                        newFood[header] = input.value.trim();
                    } else {
                        newFood[header] = parseFloat(input.value) || 0;
                    }
                });

                if (!isValid) return;

                if (storedFoods.some(food => food.description.toLowerCase() === newFood.description.toLowerCase())) {
                    alert('A food with this name already exists.');
                    return;
                }

                storedFoods.unshift(newFood);
                isCreatingFood = false;
                saveAndRender();
            }

            // --- TABLE RENDERING AND MANAGEMENT ---
            function renderTableHeader() {
                tableHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                nutrientHeaders.forEach(headerText => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.className = 'px-6 py-3 cursor-pointer text-sm';
                    if (headerText === 'description') {
                        th.classList.add('sticky-col');
                    }
                    th.dataset.sort = headerText;
                    th.textContent = headerText.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const icon = document.createElement('span');
                    icon.className = 'sort-icon';
                    th.appendChild(icon);
                    th.addEventListener('click', () => {
                        if (sortState.column === headerText) {
                            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortState.column = headerText;
                            sortState.direction = 'asc';
                        }
                        renderTable();
                    });
                    headerRow.appendChild(th);
                });
                tableHead.appendChild(headerRow);
            }

            function renderTable() {
                tableBody.innerHTML = '';
                if (storedFoods.length === 0 && !isCreatingFood) {
                    tablePlaceholder.style.display = 'block';
                    nutrientTable.classList.add('hidden');
                    clearAllBtn.disabled = true;
                    return;
                }
                tablePlaceholder.style.display = 'none';
                nutrientTable.classList.remove('hidden');
                clearAllBtn.disabled = false;

                const sortedFoods = sortFoods(storedFoods, sortState.column, sortState.direction);

                sortedFoods.forEach((food) => {
                    const row = tableBody.insertRow();
                    row.className = 'bg-white border-b md:border-b-0';
                    
                    nutrientHeaders.forEach(header => {
                        const cell = row.insertCell();
                        const value = food[header];
                        const prettyHeader = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        cell.dataset.label = prettyHeader;
                        
                        if (header === 'description') {
                            cell.className = 'px-6 py-4 font-medium text-gray-900 whitespace-nowrap sticky-col';
                            const removeBtn = document.createElement('span');
                            removeBtn.className = 'remove-icon';
                            removeBtn.innerHTML = '&times;';
                            removeBtn.dataset.description = food.description;
                            cell.appendChild(removeBtn);
                            
                            const textNode = document.createTextNode(value);
                            cell.appendChild(textNode);
                        } else {
                            cell.className = 'px-6 py-4';
                            cell.textContent = typeof value === 'number' ? value.toFixed(2) : value;
                        }
                    });
                });
                updateSortIcons();
            }
            
            function saveAndRender() {
                localStorage.setItem('storedFoods', JSON.stringify(storedFoods));
                renderTable();
            }

            // --- TABLE SORTING ---
            function sortFoods(foods, column, direction) {
                return [...foods].sort((a, b) => {
                    let valA = a[column];
                    let valB = b[column];
                    if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            function updateSortIcons() {
                document.querySelectorAll('#table-head th .sort-icon').forEach(icon => icon.innerHTML = '');
                const activeHeader = document.querySelector(`#table-head th[data-sort="${sortState.column}"]`);
                if (activeHeader) {
                    activeHeader.querySelector('.sort-icon').innerHTML = sortState.direction === 'asc' ? '&#9650;' : '&#9660;';
                }
            }

            // --- NUTRIENT TARGETS ---
            function renderNutrientTargets() {
                targetsListContainer.innerHTML = '';
                const savedTargets = JSON.parse(localStorage.getItem('nutrientTargets')) || {};
                const nutrientsToDisplay = nutrientHeaders.filter(h => h !== 'description');

                nutrientsToDisplay.forEach(nutrient => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `target-${nutrient}`;
                    label.textContent = nutrient.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    label.className = 'text-base font-medium text-gray-700';

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `target-${nutrient}`;
                    input.dataset.nutrient = nutrient;
                    input.className = 'w-32 p-2 border rounded-md text-base';
                    input.placeholder = '0.00';
                    input.value = savedTargets[nutrient] || '';

                    div.appendChild(label);
                    div.appendChild(input);
                    targetsListContainer.appendChild(div);
                });
            }

            saveTargetsBtn.addEventListener('click', () => {
                const targets = {};
                const inputs = targetsListContainer.querySelectorAll('input');
                inputs.forEach(input => {
                    const nutrient = input.dataset.nutrient;
                    const value = parseFloat(input.value);
                    if (!isNaN(value)) {
                        targets[nutrient] = value;
                    }
                });
                localStorage.setItem('nutrientTargets', JSON.stringify(targets));
                alert('Nutrient targets saved!');
            });

            // --- EVENT LISTENERS FOR ACTIONS ---
            tableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-icon')) {
                    const descriptionToRemove = e.target.dataset.description;
                    storedFoods = storedFoods.filter(food => food.description !== descriptionToRemove);
                    saveAndRender();
                }
            });

            clearAllBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to remove all foods from your list?')) {
                    storedFoods = [];
                    saveAndRender();
                }
            });

            // --- INITIALIZATION ---
            async function init() {
                await loadFoodData();
                renderTable();
            }

            init();
        });
    </script>

</body>
</html>

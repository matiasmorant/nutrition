<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimal Nutrition</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçé</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/tabulator-tables@5.6.1/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.6.1/dist/js/tabulator.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/ml-matrix/matrix.umd.min.js"></script>
    <script src="https://www.lactame.com/lib/ml/6.0.0/ml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.3.0/math.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        [x-cloak] { display: none !important; }
        /*hide input arrows*/
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        /* Firefox */
        input[type=number] {
          -moz-appearance: textfield;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #1e40af; /* blue-800 */
            font-weight: 600;
        }
        .remove-icon {
            padding-bottom: 2px;
            padding-right: 5px;
            cursor: pointer;
            color: #ef4444; /* red-500 */
            font-weight: bold;
            font-size: 1.25rem; /* Larger remove icon */
            line-height: 1;
        }
        .remove-icon:hover {
            color: #b91c1c; /* red-700 */
        }
        #search-results, .modal {
            z-index: 20;
        }
        .text-zero {
            color: #d1d5db; /* gray-300 */
        }
        .back-arrow {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }
        .nutrient-table th, .nutrient-table td {
            padding: 3px 8px; /* Reduced padding */
            text-align: right;
            vertical-align: baseline;
        }
        .nutrient-table th:first-child, .nutrient-table td:first-child {
            text-align: left;
        }
        .nutrient-table th {
            font-weight: 600;
            background-color: #f9fafb;
        }
        .percent-cell {
            color: #4b5563;
            font-size: 0.875rem;
        }
        .blue-btn {
            width: max-content;
            font: icon;
            background-color: #3b82f6;
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 0.6rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .blue-btn:hover {
            background-color: #2563eb;
        }
        .blue-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
        .optimize-btn {
            background-color: #8b5cf6;
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .optimize-btn:hover {
            background-color: #7c3aed;
        }
        .optimize-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px #ddd6fe;
        }
        .lock-icon {
            cursor: pointer;
            margin-left: 0.5rem;
            color: #6b7280;
            transition: color 0.2s;
        }
        .lock-icon:hover {
            color: #3b82f6;
        }
        .lock-icon.locked {
            color: #3b82f6;
        }
        .quantity-input:disabled {
            background-color: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }
        .create-food-btn {
            background-color: #f3f4f6;
            border-radius: 0.25rem;
            padding: 0.5rem;
            text-align: left;
            width: 100%;
            margin-bottom: 0.5rem;
            color: #3b82f6;
            font-weight: 500;
        }
        .create-food-btn:hover {
            background-color: #e5e7eb;
        }
        .modal-food-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            justify-content: flex-start; /* Left justify */
        }
        .modal-label {
            text-align: left;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
        }
        .nutrient-clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .nutrient-clickable:hover {
            color: #3b82f6;
            text-decoration: underline;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
        }
        .max-w-name {
            white-space: normal;
            word-wrap: break-word;
            display: inline-block;
        }
       .pill-group {
            display: inline-flex;
            background: #f1f5f9;
            border-radius: 50px;
        }
        .timeframe-selector {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 15px;
        }
        .pill-btn {
            padding: 5px 10px;
            cursor: pointer;
            border: 1px solid #d1d5db;
        }
        .pill-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .pill-btn:first-child {
            border-radius: 50px 0 0 50px;
        }
        .pill-btn:last-child {
            border-radius: 0 50px 50px 0;
        }
        /* Tabulator custom styles */
        .tabulator {
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .tabulator .tabulator-header {
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .tabulator .tabulator-header .tabulator-col {
            justify-content: center;
        } 
        .tabulator .tabulator-col-title {
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #4b5563;
            white-space: normal; /* Allow header wrapping */
            line-height: 1.2; /* Better line spacing */
            height: auto; /* Allow height to adjust */
            padding: 8px 5px; /* Add padding for wrapping */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .tabulator-row .tabulator-cell {
            font-size: 0.9rem;
            padding: 8px;
            border-right: none;
        }
        .tabulator-row .tabulator-cell:first-child               { border-left: none;}
        .tabulator-row:nth-child(2n) .tabulator-cell:first-child { border-left: none;}

        .tabulator-row.tabulator-row-even {
            background-color: #f9fafb;
        }
        /* Allow sticky column to wrap */
        .tabulator-col[name="name"] .tabulator-col-content {
            white-space: normal;
            line-height: 1.2;
            padding: 8px 5px;
        }
        .nameColumnCell {
            max-width: 300px;
            min-width: 150px;
        }

        /* Reduce sticky column width on narrow screens */
        @media (max-width: 640px) {
            .nameColumnCell {
                max-width: 150px;
            }
        }
        
        /* Diet menu dropdown styles */
        .diet-menu-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.25rem;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
            min-width: 120px;
        }
        .diet-menu-item {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .diet-menu-item:hover {
            background-color: #f3f4f6;
        }
        .diet-menu-item.delete {
            color: #dc2626;
        }
        .diet-menu-item.delete:hover {
            background-color: #fee2e2;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 text-base" x-data="foodApp()" x-cloak>

    <div x-show="installPromptEvent && !isStandalone" class="fixed top-4 right-4 z-50">
        <button @click="installPWA()" class="flex flex-col w-min items-center gap-2 bg-blue-500 text-white font-semibold px-2 py-2 rounded-lg shadow-lg hover:bg-blue-600 transition-colors">
            <i class="fas fa-mobile-alt"></i>
            Install App
        </button>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <div class="sticky top-0 z-10 bg-gray-50">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4 sm:space-x-8 overflow-x-auto" aria-label="Tabs">
                    <button @click="activeTab = 'diets'; selectedDiet = null" :class="{'active': activeTab === 'diets'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Diets</button>
                    <button @click="activeTab = 'targets'" :class="{'active': activeTab === 'targets'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Nutrient Targets</button>
                    <button @click="activeTab = 'foods'" :class="{'active': activeTab === 'foods'}" class="tab-btn whitespace-nowrap py-4 px-2 sm:px-1 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300">Foods</button>
                </nav>
            </div>
        </div>

        <div id="content-foods" class="tab-content" x-show="activeTab === 'foods'">
            <div class="mt-4">
                <div class="flex flex-row justify-between items-center mb-4 gap-2">
                    <input type="text" x-model.debounce.300ms="foodTableFilter" class="w-full p-2 border rounded-md" placeholder="Search foods">
                    <div class="flex gap-2">
                        <button @click="openAddFoodModal()" class="blue-btn">Add Food</button>
                        <button @click="openAddNutrientModal()" class="blue-btn">Add Nutrient</button>
                    </div>
                </div>

                <div id="food-table-container" class="mt-4 bg-white rounded-lg shadow" x-show="foodNames.length > 0"></div>

                <div id="table-placeholder" class="text-center p-8 text-gray-500" x-show="foodNames.length === 0">
                    <p>Your added foods will appear here.</p>
                </div>
            </div>
        </div>

        <div id="content-targets" class="tab-content flex flex-col w-fit mx-auto items-end gap-4 p-6 mt-6 bg-white rounded-lg shadow" x-show="activeTab === 'targets'">
            <button @click="openAddNutrientModal()" class="blue-btn">Add Nutrient</button>
            <div id="targets-list" class="grid grid-cols-1 lg:grid-cols-2 gap-x-20 gap-y-1 max-w-fit">
                <template x-for="nutrient in nutrientNames" :key="nutrient">
                    <div class="grid grid-cols-[1fr_min-content_min-content] items-center gap-x-1">
                        <div class="flex items-center">
                            <span @click="removeNutrient(nutrient)" class="remove-icon">&times;</span>
                            <label :for="`target-min-${nutrient}`" 
                                   x-text="nutrient" 
                                   @click="openNutrientInfoModal(nutrient)"
                                   class="text-sm font-medium text-gray-700 cursor-pointer hover:text-blue-600 underline-offset-2 hover:underline"></label>
                            </div>
                        <div class="flex w-32 justify-center items-center gap-1">
                            <input 
                                type="number" 
                                :id="`target-min-${nutrient}`" 
                                x-model.number="getTarget(nutrient).min" 
                                @change="saveTargets()"
                                class="w-14 p-2 border rounded-md text-sm"
                                placeholder="Min"
                            >
                            <span x-show="getTarget(nutrient).isRange">-</span>
                            <input 
                                type="number" 
                                :id="`target-max-${nutrient}`" 
                                x-model.number="getTarget(nutrient).max" 
                                @change="saveTargets()"
                                x-show="getTarget(nutrient).isRange"
                                class="w-14 p-2 border rounded-md text-sm"
                                placeholder="Max"
                            >
                        </div>
                        <button @click="toggleTargetInputs(nutrient)" class="w-[30px] p-2 rounded-full hover:bg-gray-200 focus:outline-none" :title="!getTarget(nutrient).isRange ? 'Set range' : 'Set single value'">
                            <span x-show="getTarget(nutrient).isRange">
                                <svg width="16" height="16" viewBox="0 0 16 16" class="text-gray-600"><circle cx="8" cy="8" r="2" fill="currentColor"/></svg>
                            </span>
                            <span x-show="!getTarget(nutrient).isRange">
                                <svg width="16" height="16" viewBox="0 0 16 16" class="text-gray-600"><circle cx="5" cy="8" r="2" fill="currentColor"/><circle cx="11" cy="8" r="2" fill="currentColor"/></svg>
                            </span>
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <div id="content-diets" class="tab-content p-6 mt-6 bg-white rounded-lg shadow" x-show="activeTab === 'diets'">
            <div x-show="!selectedDiet">
                <div x-show="diets.length > 0" class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <button @click="createDiet()" class="blue-btn">Create Diet</button>
                </div>
                
                <div class="border rounded-lg">
                    <template x-if="diets.length === 0">
                        <div class="p-6 bg-gray-50 rounded-lg text-center">
                            <div class="max-w-2xl mx-auto">
                                <h3 class="text-2xl font-bold text-gray-800 mb-4">Welcome to</h3>
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">Optimal Nutrition</h2>
                                
                                <div class="text-left space-y-4 mb-6">
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <h4 class="font-semibold text-blue-600 flex items-start">
                                            <span class="bg-blue-100 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center mr-2 mt-0.5">1</span>
                                            Purpose
                                        </h4>
                                        <p class="mt-2 text-gray-600">Optimize your nutrient intake by analyzing food combinations to meet your nutritional targets.</p>
                                    </div>
                                    
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <h4 class="font-semibold text-blue-600 flex items-start">
                                            <span class="bg-blue-100 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center mr-2 mt-0.5">2</span>
                                            What It Does
                                        </h4>
                                        <ul class="mt-2 text-gray-600 list-disc pl-5 space-y-1">
                                            <li>Analyze nutritional profiles of foods</li>
                                            <li>Analyze nutrient contributions of each food item to your diet</li>
                                            <li>Optimize food combinations automatically</li>
                                            <li>Suggest foods to add to your diet to supply deficient nutrients</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <h4 class="font-semibold text-blue-600 flex items-start">
                                            <span class="bg-blue-100 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center mr-2 mt-0.5">3</span>
                                            How To Use
                                        </h4>
                                        <ol class="mt-2 text-gray-600 list-decimal pl-5 space-y-2">
                                            <li><span class="font-medium">Create a diet</span> and add foods to it</li>
                                            <li><span class="font-medium">Set targets</span> in the Nutrient Targets tab</li>
                                            <li><span class="font-medium">Optimize your diet</span> using the Optimize and Suggest Food buttons</li>
                                            <li><span class="font-medium">Explore and Create new foods</span> in the Foods tab</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                <button 
                                    @click="createDiet()" 
                                    class="blue-btn px-6 py-3 text-lg font-semibold mx-auto"
                                >
                                    <i class="fas fa-plus-circle mr-2"></i>Create Your First Diet
                                </button>
                            </div>
                        </div>
                    </template>

                    <template x-for="diet in diets" :key="diet.id">
                        <div class="flex justify-between items-center p-4 border-b hover:bg-gray-50">
                            <div class="flex items-center cursor-pointer" @click="selectDiet(diet)">
                                <span x-text="diet.name" class="font-medium max-w-name"></span>
                            </div>
                            <div class="relative">
                                <button @click.stop="activeDietMenu = (activeDietMenu === diet.id ? null : diet.id)" class="p-1 rounded hover:bg-gray-200 focus:outline-none">
                                    <i class="fas fa-ellipsis-v text-gray-500"></i>
                                </button>
                                <div x-show="activeDietMenu === diet.id" @click.outside="activeDietMenu = null" class="diet-menu-dropdown">
                                    <button @click.stop="cloneDiet(diet)" class="diet-menu-item w-full text-left">Clone</button>
                                    <button @click.stop="deleteDiet(diet.id)" class="diet-menu-item delete w-full text-left">Delete</button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <template x-if="selectedDiet"><div x-show="selectedDiet">
                <div class="flex items-center mb-6">
                    <span @click="selectedDiet = null" class="back-arrow">‚Üê</span>
                    <input type="text" x-model="selectedDiet.name" @change="saveDiets()" class="text-xl font-medium border-b border-gray-300 focus:border-blue-500 focus:outline-none" placeholder="Diet name">
                </div>
                
                <div class="flex justify-center"> <div>
                    <div class="timeframe-selector mb-6">
                        <span class="text-l font-medium text-gray-700">Per</span>
                        <div class="pill-group">
                            <button @click="dietTimeframe = 'day'" :class="{'pill-btn': true, 'active': dietTimeframe === 'day'}">Day</button>
                            <button @click="dietTimeframe = 'week'" :class="{'pill-btn': true, 'active': dietTimeframe === 'week'}">Week</button>
                            <button @click="dietTimeframe = 'month'" :class="{'pill-btn': true, 'active': dietTimeframe === 'month'}">Month</button>
                        </div>
                    </div>
                    <div class="mb-6 max-w-xl">
                        <h4 class="text-lg font-medium mb-4">Diet Foods</h4>
                        <div class="text-right mb-2" x-show="unusedDietFoodCount > 0">
                            <button @click="showUnusedDietFoods = !showUnusedDietFoods" class="text-sm text-blue-600 hover:underline">
                                <span x-show="showUnusedDietFoods">Hide <span x-text="unusedDietFoodCount"></span> unused food(s)</span>
                                <span x-show="!showUnusedDietFoods">Show <span x-text="unusedDietFoodCount"></span> unused food(s)</span>
                            </button>
                        </div>
                        <div id="diet-foods-list" class="grid grid-cols-1 gap-y-4 mb-8">
                            <template x-if="selectedDiet.foods.length === 0">
                                <p class="text-gray-500">No foods added to this diet yet.</p>
                            </template>
                            <template x-for="(foodItem, index) in sortedDietFoods" :key="index">
                                <div class="flex items-center justify-between" x-show="showUnusedDietFoods || foodItem.quantity > 0">
                                    <div class="flex items-center">
                                        <span @click="removeFoodFromDiet(foodItem.foodName)" class="remove-icon">&times;</span>
                                        <span @click="showFoodContribution(foodItem.foodName)" 
                                              class="text-sm font-medium max-w-name cursor-pointer hover:text-blue-600" 
                                              x-text="foodItem.foodName"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" 
                                               :value="foodItem.quantity * factor" 
                                               @input="foodItem.quantity = parseFloat($event.target.value) / factor || 0"
                                               min="0" 
                                               step="1" 
                                               :disabled="foodItem.locked"
                                               class="w-14 p-2 border rounded-md text-sm quantity-input" 
                                               placeholder="Quantity">
                                        <span>g</span>
                                        <i 
                                            :class="{
                                                'fa-solid': true,
                                                'fa-lock': foodItem.locked,
                                                'fa-lock-open': !foodItem.locked,
                                                'lock-icon': true,
                                                'locked': foodItem.locked
                                            }" 
                                            @click="foodItem.locked = !foodItem.locked; saveDiets()"
                                            title="Lock quantity for optimization"
                                        ></i>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="mt-4 flex justify-end gap-2">
                            <button @click="isAddingFood = true; addFoodContext = 'diet'; resetFoodModal()" class="blue-btn">Add Food</button>
                            <button @click="suggestFood()" class="blue-btn">Suggest Food</button>
                            <button @click="optimizeDiet()" class="optimize-btn">Optimize</button>
                        </div>
                    </div>
                    <div x-show="selectedDiet.foods.length > 0">
                        <h4 class="text-lg font-medium mb-4">Nutrient Summary</h4>
                        <div class="overflow-x-auto flex justify-center">
                            <table class="w-full max-w-xl nutrient-table">
                                <thead>
                                    <tr>
                                        <th class="text-left">Nutrient</th>
                                        <th>Total Amount</th>
                                        <th>% of Target</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="nutrient in nutrientNames" :key="nutrient">
                                        <tr class="py-1">
                                            <td class="text-left nutrient-clickable max-w-name" @click="showNutrientContribution(nutrient)" x-text="nutrient"></td>
                                            <td x-text="(x=>x<10?x.toFixed(2):x.toFixed(0))(dietTotals[nutrient] || 0)"></td>
                                            <td>
                                                <span x-text="calculateNutrientPercentage(nutrient).toFixed(0) + '%'"></span>
                                                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                                    <div class="bg-blue-600 h-2.5 rounded-full" 
                                                        :style="'width: ' + Math.min(100, calculateNutrientPercentage(nutrient)) + '%'"
                                                        :class="{
                                                            'bg-green-600' : calculateNutrientPercentage(nutrient) >= 98 && calculateNutrientPercentage(nutrient) < 102,
                                                            'bg-yellow-400': (calculateNutrientPercentage(nutrient) >=  83 && calculateNutrientPercentage(nutrient) < 98) || (calculateNutrientPercentage(nutrient) >= 102 && calculateNutrientPercentage(nutrient) < 120),
                                                            'bg-orange-500': (calculateNutrientPercentage(nutrient) >=  67 && calculateNutrientPercentage(nutrient) < 83)||(calculateNutrientPercentage(nutrient) >= 120 && calculateNutrientPercentage(nutrient) < 150),
                                                            'bg-red-500': (calculateNutrientPercentage(nutrient) < 67) || (calculateNutrientPercentage(nutrient) >= 150)
                                                        }">
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div></div>
            </div></template>
        </div>
    </div>

    <div x-show="isAddingFood" @keydown.escape.window="isAddingFood = false" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="isAddingFood = false" class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add Food</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" x-model.debounce.300ms="searchQuery" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Search for a food...">
                </div>
                <div class="max-h-60 overflow-y-auto border rounded-md">
                    <button 
                        x-show="searchQuery && (addFoodContext != 'diet')"
                        @click="createNewFoodFromSearch()" 
                        class="create-food-btn"
                    >
                        <i class="fas fa-plus-circle mr-2"></i> Create new food: <span x-text="searchQuery"></span>
                    </button>
                    
                    <ul class="divide-y divide-gray-200">
                        <template x-for="food in searchResults.slice(0, 60)" :key="food.name">
                            <li class="modal-food-item">
                                <input 
                                    type="checkbox" 
                                    :id="'food-'+food.name" 
                                    :checked="addFoodContext === 'diet' ? 
                                        (selectedDiet && selectedDiet.foods.some(f => f.foodName === food.name)) :
                                        foodNames.includes(food.name)"
                                    @change="toggleFoodSelection(food)"
                                    class="mr-3"
                                >
                                <label :for="'food-'+food.name" x-text="food.name" class="flex-1 modal-label max-w-name"></label>
                            </li>
                        </template>
                        <template x-if="searchResults.length === 0">
                            <li class="p-4 text-gray-500">No foods found.</li>
                        </template>
                    </ul>
                </div>
                <div class="items-center px-4 py-3">
                    <button @click="isAddingFood = false; addFoodContext = null" class="blue-btn bg-gray-500 hover:bg-gray-600 w-full">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="isAddingColumn" @keydown.escape.window="isAddingColumn = false" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="isAddingColumn = false" class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add Nutrient Column</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" x-model="nutrientSearchQuery" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Search for a nutrient...">
                </div>
                <div class="max-h-60 overflow-y-auto border rounded-md">
                    <ul class="divide-y divide-gray-200">
                        <template x-for="nutrient in filteredAvailableNutrients" :key="nutrient">
                            <li class="modal-food-item">
                                <input 
                                    type="checkbox" 
                                    :id="'nutrient-'+nutrient" 
                                    :checked="nutrientNames.includes(nutrient)"
                                    @change="toggleNutrient(nutrient)"
                                    class="mr-3"
                                >
                                <label :for="'nutrient-'+nutrient" x-text="nutrient" class="flex-1 modal-label max-w-name"></label>
                            </li>
                        </template>
                        <template x-if="filteredAvailableNutrients.length === 0">
                            <li class="p-4 text-gray-500">No available nutrients found.</li>
                        </template>
                    </ul>
                </div>
                <div class="items-center px-4 py-3">
                    <button @click="isAddingColumn = false" class="blue-btn bg-gray-500 hover:bg-gray-600 w-full">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="isChartModalVisible" @keydown.escape.window="isChartModalVisible = false" 
         class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="isChartModalVisible=false" class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="chart-container">
                <canvas id="pieChart"></canvas>
            </div>
            <button @click="isChartModalVisible = false" class="mt-4 blue-btn w-full">Close</button>
        </div>
    </div>

    <div x-show="showSuggestModal" @keydown.escape.window="showSuggestModal = false" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="showSuggestModal = false" class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Suggested Foods</h3>
                <div class="mt-4 max-h-60 overflow-y-auto border rounded-md">
                    <ul class="divide-y divide-gray-200">
                        <template x-for="food in suggestedFoods" :key="food.name">
                            <li class="flex justify-between items-center p-3 hover:bg-gray-50">
                                <span class="max-w-name" x-text="food.name"></span>
                                <button @click="addSuggestedFood(food)" class="blue-btn text-xs px-3 py-1">Add</button>
                            </li>
                        </template>
                        <template x-if="suggestedFoods.length === 0">
                            <li class="p-4 text-gray-500">No suggestions available. Add foods to your diet first.</li>
                        </template>
                    </ul>
                </div>
                <div class="items-center px-4 py-3">
                    <button @click="showSuggestModal = false" class="blue-btn bg-gray-500 hover:bg-gray-600 w-full">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="isEditingFood" @keydown.escape.window="closeEditFoodModal()" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="closeEditFoodModal()" class="relative mx-auto p-5 border max-w-3xl shadow-lg rounded-md bg-white">
            <template x-if="editingFood">
                <div class="mt-3">
                    <h3 class="text-xl leading-6 font-medium text-gray-900 text-center mb-4" x-text="editingFood.name"></h3>
                    
                    <div class="grid md:grid-cols-2 gap-6 max-h-96 overflow-y-auto">
                        <div class="flex flex-col max-w-sm max-h-96 ">
                            <div class="flex justify-between items-center mb-2">
                                 <h4 class="font-semibold">Nutrients (per 100g)</h4>
                                 <button @click="showZeroNutrientsInEdit = !showZeroNutrientsInEdit" class="text-sm text-blue-600 hover:underline">
                                    <span x-show="showZeroNutrientsInEdit">Hide 0 values</span>
                                    <span x-show="!showZeroNutrientsInEdit">Show 0 values</span>
                                </button>
                            </div>
                            <div class="border rounded-md p-3 flex-grow max-h-96 overflow-y-auto">
                                <template x-for="nutrient in nutrientNames.filter(n => (showZeroNutrientsInEdit || editingFood[n] > 0)).sort()" :key="nutrient">
                                    <div class="flex items-center justify-between mb-2">
                                        <label :for="'edit-nutrient-'+nutrient" class="text-sm font-medium text-gray-700 max-w-name" x-text="nutrient"></label>
                                        <input type="number" step="any" min="0" :id="'edit-nutrient-'+nutrient" x-model.lazy="editingFood[nutrient]" class="w-24 p-1 border rounded-md text-sm text-right">
                                    </div>
                                </template>
                            </div>
                        </div>
    
                        <div class="flex flex-col max-w-sm max-h-96">
                             <div class="chart-container w-full h-80 mx-auto" style="margin-top: 0; height: 100%;">
                                <canvas id="editFoodPieChart"></canvas>
                            </div>
                        </div>
                    </div>
    
                    <div class="items-center px-4 py-3 mt-4">
                        <button @click="saveFoodEdits()" class="blue-btn w-full">
                            Save and Close
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <div x-show="isNutrientInfoModalVisible" @keydown.escape.window="isNutrientInfoModalVisible = false" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div @click.outside="isNutrientInfoModalVisible = false" class="relative mx-auto p-6 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-left">
                <div x-html="nutrientInfoContent" class="text-sm text-gray-700 leading-relaxed"></div>
            </div>
            <div class="items-center px-4 py-3 mt-4 text-right">
                <button @click="isNutrientInfoModalVisible = false" class="blue-btn bg-gray-500 hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script src="dataService.js"></script>

    <script>
        function round(x) {
          if (x === 0) return 0;
          const scale = Math.pow(10, -Math.floor(Math.log10(x)) + 1);
          return Math.round(x * scale) / scale;
        }
        function argmin(arr) {
          return arr.reduce((minI, x, i, array) => x < array[minI] ? i : minI, 0);
        }

        function constrain(values, bounds){
            return bounds.map((bound,i)=>{
                const min = bound.min || 0;
                if(bound.isRange){
                    const current= values[i] || 0;
                    const max = bound.max || (100 * bound.min);
                    return math.median([min,max,current]);
                }
                return min;
            });
        }

        function boundls(A,c, bounds, targets=null, maxIter=200, preverror=null){
            // A.x+c = *bounds*
            targets = targets || bounds.map(v=>v.min || 0);
            if (targets.length === 0) {alert("Please set targets for at least one nutrient.");return;}

            const relA = targets.map((target,i) => A[i].map(x=>x/(target > 0 ? target : 1) ));
            const b = targets.map((target,i) => (target > 0 ? 1 - c[i] / target : -c[i]) );

            const solution = ML.FCNNLS.fcnnlsVector(relA, b);
            const error = math.norm(math.subtract(math.multiply(relA,solution),b));
            console.log(maxIter,error);
            if(preverror && preverror-error<1e-4) return solution;
            const LHS = math.add(math.multiply(A,solution),c);
            const easier = constrain(LHS, bounds);
            if(maxIter===0) return solution;
            return boundls(A, c, bounds, easier, maxIter-1, error);
        }

        Object.defineProperty(Array.prototype, 'sum', {
            value: function (selector = x => x) {
              return this.reduce((s,x) => s + selector(x), 0);
            },
            enumerable: false
        });

        function foodApp() {
            return {
                // --- STATE ---
                allFoods: [],
                foodNames: [],
                nutrientHeaders: [],
                nutrientNames: [],
                nutrientTreeNames: [],
                searchQuery: '',
                searchResults: [],
                isLoading: false,
                activeTab: 'diets',
                nutrientTargets: {},
                isAddingColumn: false,
                isAddingFood: false,
                nutrientSearchQuery: '',
                addFoodContext: null,
                foodTable: null,
                foodTableFilter: '',
                
                // Diets state
                predefinedDiets: [],
                diets: [],
                selectedDiet: null,
                dietTimeframe: 'day',
                showUnusedDietFoods: true,
                dietTotals: {},
                
                // Chart state
                isChartModalVisible: false,
                pieChart: null,

                // Edit Food Modal state
                isEditingFood: false,
                editingFood: null,
                editFoodPieChartInstance: null,
                showZeroNutrientsInEdit: false,

                // Suggest Food state
                showSuggestModal: false,
                suggestedFoods: [],
                
                // Nutrient Info Modal state
                nutrientInfo: {},
                isNutrientInfoModalVisible: false,
                nutrientInfoContent: '',

                // PWA Install state
                installPromptEvent: null,
                isStandalone: false,

                // Diet menu state
                activeDietMenu: null,

                // --- COMPUTED PROPERTIES ---
                get filteredAvailableNutrients() {
                    if (!this.nutrientTreeNames || !this.nutrientHeaders) return [];
                    const availableNutrients = this.nutrientTreeNames.filter(h => this.nutrientHeaders.includes(h));
                    if (!this.nutrientSearchQuery) return availableNutrients;
                    return availableNutrients.filter(h => h.toLowerCase().includes(this.nutrientSearchQuery.toLowerCase()));
                },
                get factor() {
                    if (this.dietTimeframe === 'day') return 1;
                    if (this.dietTimeframe === 'week') return 7;
                    return 30; // month
                },
                get sortedDietFoods() {
                    if (!this.selectedDiet || !this.selectedDiet.foods) return [];
                    return this.selectedDiet.foods.slice().sort((a, b) => a.foodName.localeCompare(b.foodName));
                },
                get unusedDietFoodCount() {
                    if (!this.selectedDiet || !this.selectedDiet.foods) return 0;
                    return this.selectedDiet.foods.filter(f => f.quantity === 0).length;
                },

                // --- METHODS ---
                async init() {
                    this.isStandalone = window.matchMedia('(display-mode: standalone)').matches;
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        this.installPromptEvent = e;
                    });
                    
                    this.isLoading = true;

                    // Load all data using the dataService
                    await dataService.init();
                    const [predefinedDiets, foodNames, diets, nutrientTargets, nutrientTree, foodData, nutrientInfo] = await Promise.all([
                        dataService.fetchPredefinedDiets(),
                        dataService.getAllFoodNames(),
                        dataService.get('diets',[]),
                        dataService.get('nutrientTargets',{}),
                        dataService.fetchNutrientTree(),
                        dataService.fetchFoodData(),
                        dataService.fetchNutrientInfo()
                    ]);
                    
                    this.predefinedDiets = predefinedDiets;
                    this.foodNames = foodNames;
                    this.diets = diets;
                    this.nutrientTargets = nutrientTargets;
                    this.nutrientInfo = nutrientInfo;
                    
                    this.allFoods = foodData.allFoods;
                    this.nutrientHeaders = foodData.nutrientHeaders;

                    this.nutrientTreeNames = nutrientTree.allNutrients;
                    this.nutrientNames = [...nutrientTree.defaultDisplayNutrients];
                    
                    this.isLoading = false;
                    
                    if (this.foodNames.length === 0 && this.allFoods.length > 0) {
                        this.foodNames = this.allFoods.map(food => food.name);
                        await dataService.saveFoods(this.allFoods);
                    }
                    
                    this.nutrientTargets = { ...nutrientTree.defaultNutrientTargets, ...this.nutrientTargets };
                    await this.saveTargets();
                    
                    this.initFoodTable();
                    
                    this.$watch('searchQuery', () => this.searchFoods());
                    this.$watch('nutrientTargets', () => this.saveTargets(), { deep: true });
                    this.$watch('foodTableFilter', () => this.updateFoodTableFilter());
                    this.$watch('editingFood', (newValue) => {
                        if (this.isEditingFood && newValue) this.renderEditFoodPieChart();
                    }, { deep: true });
                    
                    this.$watch('selectedDiet', async () => {
                        if (this.selectedDiet) {
                            await this.recalculateDietTotals();
                        }
                    }, { deep: true });
                },

                async installPWA() {
                    if (!this.installPromptEvent) return;
                    this.installPromptEvent.prompt();
                    const { outcome } = await this.installPromptEvent.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    this.installPromptEvent = null;
                },
                
                openNutrientInfoModal(nutrient) {
                    const info = this.nutrientInfo[nutrient];
                    if (info && info.trim()) {
                        this.nutrientInfoContent = `<h4 class="font-bold text-lg mb-2">${nutrient}</h4>${info}`;
                        this.isNutrientInfoModalVisible = true;
                    }
                },

                updateFoodTableFilter() {
                    if (this.foodTable) {
                        this.foodTable.setFilter('name', 'like', this.foodTableFilter);
                    }
                },

                async initFoodTable() {
                    if (this.foodTable) this.foodTable.destroy();

                    const foods = await dataService.getAllFoods();
                    
                    const columns = [
                        {
                            formatter: (cell, formatterParams, onRendered) => `<span class="remove-icon" title="Remove food">&times;</span>`,
                            width: 40, hozAlign: "center", headerSort: false, resizable: false,
                            cellClick: async (e, cell) => {
                                if (confirm('Are you sure you want to remove this food? This cannot be undone.')) {
                                    await this.removeFood(cell.getRow().getData().name);
                                }
                            },
                        },
                        { 
                            title: "Name", field: "name", cssClass: "nameColumnCell nutrient-clickable",
                            minWidth: 150,
                            resizable: false, frozen: true, headerWordWrap: true,
                            cellClick: (e, cell) => this.openEditFoodModal(cell.getRow().getData().name)
                        },
                        ...this.nutrientNames.map(nutrient => {return {
                                title: nutrient, field: nutrient, editor: "number", resizable: false,
                                editorParams: { step: 0.01 }, sorter: "number", headerSort:false,
                                maxWidth: 110,
                                cellEdited: async (cell) => {
                                    await dataService.addOrUpdateFood(cell.getRow().getData());
                                },
                                headerClick: (e,column) => {
                                    const field = column.getField();
                                    const isDesc = this.foodTable.getSorters().some(s => s.field === field && s.dir === "desc");
                                    this.foodTable.setSort(isDesc ? "name" : field, isDesc ? "asc" : "desc");
                                },
                                hozAlign: "right",
                                formatter: (cell) => {
                                    const value = cell.getValue();
                                    cell.getElement().classList.toggle('text-zero', value === 0);
                                    return value;
                                },
                                headerWordWrap: true,
                            };
                        })
                    ];

                    this.foodTable = new Tabulator("#food-table-container", {
                        index: "name",
                        data: foods,
                        columns: columns,
                        layout: "fitDataStretch",
                        height: "600px",
                        headerHeight: 50,
                        rowDeleted: async (row) => {
                            await this.removeFood(row.getData().name);
                        },
                    });
                    this.updateFoodTableFilter();
                },
                
                async searchFoods() {
                    const source = this.addFoodContext === 'diet' ? 
                        await dataService.getAllFoods() : 
                        this.allFoods;
                    
                    if (this.searchQuery === '') {
                        this.searchResults = source;
                    } else {
                        this.searchResults = source.filter(food => 
                            food.name.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );
                    }
                },

                async addFood(foodObject) {
                    if (this.foodNames.includes(foodObject.name)) return;
                    this.foodNames.push(foodObject.name);
                    this.foodTable.addRow(foodObject);
                    await dataService.addOrUpdateFood(foodObject);
                },

                async removeFood(name) {
                    await dataService.deleteFood(name);
                    this.foodNames = this.foodNames.filter(n => n !== name);
                    
                    const row = this.foodTable.getRows().find(r => r.getData().name === name);
                    if (row) row.delete();
                    
                    this.diets.forEach(diet => {
                        diet.foods = diet.foods.filter(item => item.foodName !== name);
                    });
                    await this.saveDiets();
                },

                addNutrient(nutrient) {
                    if (!this.nutrientNames.includes(nutrient)) {
                        this.nutrientNames.push(nutrient);
                    }
                },

                removeNutrient(nutrient) {
                    this.nutrientNames = this.nutrientNames.filter(n => n !== nutrient);
                    delete this.nutrientTargets[nutrient];
                },

                async saveTargets() { await dataService.set('nutrientTargets',this.nutrientTargets); },
                async saveDiets() { await dataService.set('diets',this.diets); },

                getTarget(nutrient) {
                    return this.nutrientTargets[nutrient] ?? { min: 0, max: null, isRange: false };
                },

                toggleTargetInputs(nutrient) {
                    const target = this.getTarget(nutrient);
                    target.isRange = !target.isRange;
                },
                
                async createDiet() {
                    let templateDiet;
                    if (this.predefinedDiets && this.predefinedDiets.length > 0) {
                        const randomIndex = Math.floor(Math.random() * this.predefinedDiets.length);
                        templateDiet = this.predefinedDiets[randomIndex];
                    } else {
                        templateDiet = { name: `Diet ${this.diets.length + 1}`, foods: [] };
                    }
                    const newDiet = { id: Date.now().toString(), name: templateDiet.name, foods: JSON.parse(JSON.stringify(templateDiet.foods)) };
                    this.diets.push(newDiet);
                    await this.saveDiets();
                    this.selectDiet(newDiet);
                },
                
                async deleteDiet(id) {
                    this.diets = this.diets.filter(diet => diet.id !== id);
                    if (this.selectedDiet && this.selectedDiet.id === id) this.selectedDiet = null;
                    this.activeDietMenu = null;
                    await this.saveDiets();
                },
                
                selectDiet(diet) { 
                    this.selectedDiet = diet; 
                    this.activeDietMenu = null;
                },
                
                async cloneDiet(diet) {
                    const clonedDiet = {
                        id: Date.now().toString(),
                        name: `Copy of ${diet.name}`,
                        foods: JSON.parse(JSON.stringify(diet.foods))
                    };
                    this.diets.push(clonedDiet);
                    await this.saveDiets();
                    this.activeDietMenu = null;
                },
                
                async addFoodToDiet(foodName) {
                    const existingIndex = this.selectedDiet.foods.findIndex(f => f.foodName === foodName);
                    if (existingIndex >= 0) {
                        this.selectedDiet.foods[existingIndex].quantity += 100;
                    } else {
                        this.selectedDiet.foods.push({ foodName, quantity: 100, locked: false });
                    }
                    await this.saveDiets();
                },
                
                async removeFoodFromDiet(foodName) {
                    this.selectedDiet.foods = this.selectedDiet.foods.filter(f => f.foodName !== foodName);
                    await this.saveDiets();
                },
                
                async recalculateDietTotals() {
                    if (!this.selectedDiet) return;
                    
                    const dietTotals = {};

                    // Calculate totals for each nutrient
                    for (const nutrient of this.nutrientNames) {
                        let total = 0;
                        for (const foodItem of this.selectedDiet.foods) {
                            const food = await dataService.getFood(foodItem.foodName);
                            if (food && food[nutrient] !== undefined) {
                                total += (food[nutrient] * foodItem.quantity) / 100;
                            }
                        }
                        dietTotals[nutrient] = total;
                    }
                    this.dietTotals = dietTotals;
                },
                
                calculateNutrientPercentage(nutrient) {
                    const total = this.dietTotals[nutrient] || 0;
                    const target = this.nutrientTargets[nutrient];
                    if (!target) return 100;

                    const min = target.min || 0;
                    const max = target.max;

                    if (min <= 0) return 100;
                    if (max !== null && total >= min && total <= max) return 100;
                    if (max !== null && total > max) return (total / max) * 100;
                    return (total / min) * 100;
                },

                async dietMatrices() {
                    const nutrientNames = Object.keys(this.nutrientTargets);
                    const dietFoods=this.selectedDiet.foods;

                    const bounds = Object.values(this.nutrientTargets);

                    const nutrientData = {};
                    for (const foodItem of dietFoods) {
                        nutrientData[foodItem.foodName] = await dataService.getFood(foodItem.foodName);
                    }

                    const getA=(food,nutrient)=>(nutrientData[food.foodName][nutrient] || 0) / 100;

                    const locked = dietFoods.filter(f => f.locked);
                    const unlocked = dietFoods.filter(f => !f.locked);

                    const lockedNutrients = nutrientNames.map(nutrient => locked.sum(food => 
                        (getA(food,nutrient) * food.quantity)
                    ));                        

                    const A = nutrientNames.map(nutrient => unlocked.map(food => getA(food,nutrient) ));
                    const nutrientValue = nutrientNames.map(nutrient=>this.dietTotals[nutrient]);

                    const unlockedamounts=null; // TODO

                    return {A, lockedNutrients, unlockedamounts, nutrientValue, bounds};
                },

                async optimizeDiet() {
                    if (!this.selectedDiet || this.selectedDiet.foods.length === 0) {
                        alert("Please add foods to the diet first.");
                        return;
                    }
                    
                    const dietFoods=this.selectedDiet.foods;
                    const locked = dietFoods.filter(f => f.locked);
                    const unlocked = dietFoods.filter(f => !f.locked);

                    if (unlocked.length === 0) {alert("No unlocked foods to optimize."); return;}
                    
                    const nutrientData = {};
                    for (const foodItem of dietFoods) {
                        nutrientData[foodItem.foodName] = await dataService.getFood(foodItem.foodName);
                    }

                    const getA=(food,nutrient)=>(nutrientData[food.foodName][nutrient] || 0) / 100;

                    const nutrientNames = Object.keys(this.nutrientTargets);
                    const lockedNutrients = nutrientNames.map(nutrient => locked.sum(food => 
                        (getA(food,nutrient) * food.quantity)
                    ));                        

                    const bounds = Object.values(this.nutrientTargets);
                    let A = nutrientNames.map(nutrient => unlocked.map(food => getA(food,nutrient) ));

                    try {
                        const solution = boundls(A, lockedNutrients, bounds);
                        unlocked.forEach((food, i) => {food.quantity = round(Math.max(0, solution[i]));});
                        await this.saveDiets();
                        this.recalculateDietTotals();
                    } catch (error) {
                        console.error("Optimization error:", error);
                        alert("Failed to optimize diet. The combination of foods and targets may not be solvable.");
                    }
                },
                
                async createNewFoodFromSearch() {
                    const name = this.searchQuery.trim();
                    if (!name) return alert('Please enter a food name');
                    if (this.foodNames.includes(name)) return alert('A food with this name already exists.');
                    
                    const newFood = { name };
                    this.nutrientHeaders.forEach(header => {
                        if (header !== 'name') newFood[header] = 0;
                    });
                    
                    await this.addFood(newFood);
                    
                    if (this.addFoodContext === 'diet' && this.selectedDiet) {
                        await this.addFoodToDiet(name);
                    }
                    
                    this.isAddingFood = false;
                    this.addFoodContext = null;
                    this.searchQuery = '';
                    
                    this.showZeroNutrientsInEdit = true;
                    this.openEditFoodModal(name);
                },

                async toggleFoodSelection(food) {
                    if (this.addFoodContext === 'diet') {
                        if (this.selectedDiet.foods.some(f => f.foodName === food.name)) {
                            await this.removeFoodFromDiet(food.name);
                        } else {
                            await this.addFoodToDiet(food.name);
                        }
                    } else {
                        if (this.foodNames.includes(food.name)) {
                            await this.removeFood(food.name);
                        } else {
                            await this.addFood(food);
                        }
                    }
                },
                
                toggleNutrient(nutrient) {
                    if (this.nutrientNames.includes(nutrient)) {
                        this.removeNutrient(nutrient);
                    } else {
                        this.addNutrient(nutrient);
                    }
                    this.initFoodTable();
                },
                
                resetFoodModal() { this.searchQuery = ''; this.searchResults = []; },
                openAddFoodModal() { this.resetFoodModal(); this.isAddingFood = true; this.addFoodContext = null; },
                openAddNutrientModal() { this.nutrientSearchQuery = ''; this.isAddingColumn = true; },
                
                _createPieChart(canvasId, title, labels, data) {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    return new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8AC926', '#1982C4', '#F44336', '#E91E63', '#9C27B0', '#673AB7'].slice(0, data.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: title, font: { size: 16 } },
                                tooltip: { callbacks: { label: ctx => ctx.label } },
                                legend: { position: 'right', align: 'bottom'}
                            }
                        }
                    });
                },

                renderPieChart(title, data, labels) {
                    if (this.pieChart) this.pieChart.destroy();
                    const combined = data.map((value, i) => ({ value, label: labels[i] })).sort((a, b) => b.value - a.value);
                    this.pieChart = this._createPieChart(
                        'pieChart', title, combined.map(item => item.label), combined.map(item => item.value)
                    );
                },

                groupPie(items) {
                    const total = items.sum(x =>x.value);
                    const sorted = items.slice().sort((a, b) => b.value - a.value);
                    const topItems = sorted.slice(0, 9);
                    const otherItems = sorted.slice(9);
                    const significantItems = topItems.filter(item => item.value / total >= 0.05);
                    const smallTopItems = topItems.filter(item => item.value / total < 0.05);
                    const labels = significantItems.map(item => item.name);
                    const values = significantItems.map(item => item.value);
                    const otherTotal = [...smallTopItems,...otherItems].sum(x=>x.value)
                    if (otherTotal > 0) {
                        labels.push('Other');
                        values.push(otherTotal);
                    }
                    return {labels, values}
                },

                async showNutrientContribution(nutrient) {
                    this.isChartModalVisible = true;
                    this.$nextTick(async () => {
                        const items = [];
                        for (const foodItem of this.selectedDiet.foods) {
                            const food = await dataService.getFood(foodItem.foodName);
                            if (food && food[nutrient]) {
                                const value = (food[nutrient] * foodItem.quantity) / 100;
                                if (value > 0) items.push({ name: food.name, value });
                            }
                        }
                        const { labels, values } = this.groupPie(items);
                        this.renderPieChart(`Contribution to ${nutrient}`, values, labels.map((x,i)=>`${values[i].toFixed(0)} ${x}`));
                    });
                },
                
                async showFoodContribution(foodName) {
                    this.isChartModalVisible = true;
                    this.$nextTick(async () => {
                        const food = await dataService.getFood(foodName);
                        const foodItem = this.selectedDiet.foods.find(f => f.foodName === foodName);
                        if (!food || !foodItem) return;
                        const items = [];
                        this.nutrientNames
                            .filter(x => food[x] > 0)
                            .forEach(nutrient => {
                                const value = (food[nutrient] || 0) * foodItem.quantity / 100 / this.dietTotals[nutrient] * 100;
                                if (value > 0) items.push({ name: nutrient, value });
                            });
                        const { labels, values } = this.groupPie(items);
                        const title = `${foodItem.quantity}g of ${foodName}`;
                        this.renderPieChart(title,values,labels.map((x,i)=>`${values[i].toFixed(0)}% ${x}`));
                    });
                },
                
                async suggestFood() {
                    if (!this.selectedDiet || this.selectedDiet.foods.length === 0) return alert("Please add foods to your diet first.");
                    const bounds = Object.values(this.nutrientTargets);
                    const nutrients = Object.keys(this.nutrientTargets);
                    const current = nutrients.map(nutrient=>this.dietTotals[nutrient]);
                    const targets = constrain(current, bounds);
                    const D = targets.map((target,i) => (current[i]/(target > 0 ? target : 1)));
                    const b=targets.map(target=>(target > 0 ? 1 : 0));
                    const D1 = math.multiply(D,b);
                    const DD = math.multiply(D,D);

                    const foodScores = this.allFoods.filter(food => !this.selectedDiet.foods.some(f => f.foodName === food.name))
                        .map(food => {
                            const F = targets.map((target,i) => (food[nutrients[i]] || 0) / 100/(target > 0 ? target : 1));
                            const F1 = math.multiply(F,b);
                            const FF = math.multiply(F,F);
                            const FD = math.multiply(F,D);
                            const determinant = FF*DD - FD*FD;
                            const xF = ( DD*F1 - FD*D1) / determinant;
                            const xD = (-FD*F1 + FF*D1) / determinant;
                            const score = xF>0?-(FF*xF*xF+2*FD*xF*xD+DD*xD*xD-2*(F1*xF+D1*xD)):-Infinity;
                            return { food, score, optimalAmount: xF, dietAmount: xD};
                            // const A=math.transpose([D,F]);                                            
                            // const x=math.multiply(math.pinv(A),b);                                    
                            // const [dietAmount,optimalAmount]=x;                                       
                            // const score = optimalAmount>0?-math.norm(math.subtract(math.multiply(A,x),b)):-Infinity;                                                                                            
                            // return { food, score, optimalAmount, dietAmount};                         
                         
                        });

                    foodScores.sort((a, b) => b.score - a.score);
                    
                    const distinctFoods = [], seenPrefixes = new Set();
                    for (const item of foodScores) {
                        const prefix = item.food.name.substring(0, 12);
                        if (!seenPrefixes.has(prefix)) {
                            distinctFoods.push(item.food);
                            seenPrefixes.add(prefix);
                        }
                        if (distinctFoods.length >= 50) break;
                    }
                    
                    this.suggestedFoods = distinctFoods;
                    this.showSuggestModal = true;
                },
                
                async addSuggestedFood(food) {
                    if (!this.foodNames.includes(food.name)) {
                        await this.addFood(food);
                    }
                    await this.addFoodToDiet(food.name);
                    this.showSuggestModal = false;
                },

                async openEditFoodModal(foodName) {
                    this.isEditingFood = true;
                    this.editingFood = await dataService.getFood(foodName);
                },

                closeEditFoodModal() {
                    this.isEditingFood = false;
                    if (this.editFoodPieChartInstance) {
                        this.editFoodPieChartInstance.destroy();
                        this.editFoodPieChartInstance = null;
                    }
                },

                async saveFoodEdits() {
                    if (!this.editingFood) return;

                    for (const key in this.editingFood) {
                        if (key !== 'name' && typeof this.editingFood[key] !== 'number') {
                            this.editingFood[key] = parseFloat(this.editingFood[key]) || 0;
                        }
                    }
                    this.foodTable.updateData([this.editingFood]);
                    await dataService.addOrUpdateFood(this.editingFood);
                    this.closeEditFoodModal();
                },

                renderEditFoodPieChart() {
                    if (this.editFoodPieChartInstance) this.editFoodPieChartInstance.destroy();
                    if (!this.editingFood) return;

                    const food = this.editingFood;
                    const chartItems = [];

                    this.nutrientNames.forEach(nutrient => {
                        const target = this.getTarget(nutrient);
                        if (target && target.min > 0) {
                            const foodValue = food[nutrient] || 0;
                            const value = (foodValue / target.min) * 100;
                            chartItems.push({ name: nutrient, value });
                        }
                    });

                    const { labels, values } = this.groupPie(chartItems);
                    const canvas = document.getElementById('editFoodPieChart');
                    const ctx = canvas.getContext('2d');

                    if (values.length === 0) {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.font = "16px Inter, sans-serif";
                        ctx.fillStyle = "#6b7280";
                        ctx.textAlign = "center";
                        ctx.fillText("No target data to display.", canvas.width / 2, canvas.height / 2);
                        return;
                    }
                    setTimeout(()=>{
                        this.editFoodPieChartInstance = this._createPieChart(
                            'editFoodPieChart',
                            '% of Nutrient Targets (per 100g)',
                            labels.map((x,i)=>`${values[i].toFixed(0)}% ${x}`),
                            values
                        );
                    },50);
                }
            }
        }
    </script>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>